<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº‹å‹™å±€ç®¡ç†ç”»é¢ - ã‚ãã‚ãã‚®ãƒ«ãƒ‰</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <div class="container">
      <h1>âš”ï¸ ã‚ãã‚ãã‚®ãƒ«ãƒ‰ - äº‹å‹™å±€</h1>
      <nav>
        <a href="admin.html">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
        <a href="index.html" target="_blank">å…¬é–‹ãƒšãƒ¼ã‚¸ã¸</a>
        <a href="#" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="admin-section">
      <h2>ğŸ›¡ï¸ äº‹å‹™å±€ç®¡ç†ç”»é¢</h2>
      
      <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
      <div class="admin-login" id="adminLogin">
        <h3>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h3>
        <form onsubmit="handleAdminLogin(event)">
          <div class="form-group">
            <label>ç®¡ç†è€…ID</label>
            <input type="text" id="adminId" required placeholder="admin">
          </div>
          <div class="form-group">
            <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="adminPassword" required placeholder="password">
          </div>
          <button type="submit" class="btn-primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </form>
        <p class="note">â€»ãƒ‡ãƒ¢ç‰ˆ: ã©ã‚“ãªID/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã‚‚ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½</p>
      </div>

      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
      <div id="adminLoading" class="loading" style="display: none;">
        <p>ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
      </div>

      <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
      <div class="admin-dashboard" id="adminDashboard" style="display: none;">
        <div class="dashboard-stats">
          <div class="stat-card">
            <h3>ğŸ“‹ å¯©æŸ»å¾…ã¡</h3>
            <p class="stat-number" id="statPending">0ä»¶</p>
            <small id="statPendingDetail">ãƒ¡ãƒ³ãƒãƒ¼: 0ä»¶ / ä¾é ¼ä¸»: 0ä»¶ / ã‚¯ã‚¨ã‚¹ãƒˆ: 0ä»¶</small>
          </div>
          <div class="stat-card">
            <h3>ğŸ”„ é€²è¡Œä¸­ã‚¯ã‚¨ã‚¹ãƒˆ</h3>
            <p class="stat-number" id="statInProgress">0ä»¶</p>
            <small>å—æ³¨æ¸ˆãƒ»é€²è¡Œä¸­ã®æ¡ˆä»¶</small>
          </div>
          <div class="stat-card">
            <h3>âœ… å®Œäº†ã‚¯ã‚¨ã‚¹ãƒˆ</h3>
            <p class="stat-number" id="statCompleted">0ä»¶</p>
            <small>ä»Šæœˆã®å®Œäº†æ•°</small>
          </div>
          <div class="stat-card">
            <h3>ğŸ’° é ã‹ã‚Šé‡‘</h3>
            <p class="stat-number" id="statDeposit">Â¥0</p>
            <small>æœªæ‰•ã„å ±é…¬ç·é¡</small>
          </div>
        </div>

        <div class="tabs">
          <button class="tab-btn active" onclick="showAdminTab('approval')">å¯©æŸ»å¾…ã¡</button>
          <button class="tab-btn" onclick="showAdminTab('quests')">ã‚¯ã‚¨ã‚¹ãƒˆç®¡ç†</button>
          <button class="tab-btn" onclick="showAdminTab('members')">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</button>
          <button class="tab-btn" onclick="showAdminTab('clients')">ä¾é ¼ä¸»ç®¡ç†</button>
          <button class="tab-btn" onclick="showAdminTab('payment')">å ±é…¬æ”¯æ‰•ç®¡ç†</button>
          <button class="tab-btn" onclick="showAdminTab('reports')">å ±å‘Šãƒ»å•é¡Œå¯¾å¿œ</button>
        </div>

        <!-- å¯©æŸ»å¾…ã¡ã‚¿ãƒ– -->
        <div id="approvalTab" class="tab-content">
          <h3>ğŸ“‹ å¯©æŸ»å¾…ã¡ä¸€è¦§</h3>
          
          <h4>ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²ç”³è«‹</h4>
          <div id="memberApprovalList">
            <p class="loading">èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>

          <h4>ä¾é ¼ä¸»ç™»éŒ²ç”³è«‹</h4>
          <div id="clientApprovalList">
            <p class="loading">èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>

          <h4>ã‚¯ã‚¨ã‚¹ãƒˆæŠ•ç¨¿å¯©æŸ»</h4>
          <div id="questApprovalList">
            <p class="loading">èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        </div>

        <!-- ã‚¯ã‚¨ã‚¹ãƒˆç®¡ç†ã‚¿ãƒ– -->
        <div id="questsTab" class="tab-content" style="display: none;">
          <h3>ğŸ—ºï¸ ã‚¯ã‚¨ã‚¹ãƒˆç®¡ç†</h3>
          <div class="filter-bar">
            <select id="questStatusFilter">
              <option value="">ã™ã¹ã¦</option>
              <option value="å‹Ÿé›†ä¸­">å‹Ÿé›†ä¸­</option>
              <option value="å—æ³¨æ¸ˆ">å—æ³¨æ¸ˆ</option>
              <option value="å®Œäº†">å®Œäº†</option>
              <option value="ã‚­ãƒ£ãƒ³ã‚»ãƒ«">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
            </select>
            <input type="text" id="questSearchInput" placeholder="ã‚¯ã‚¨ã‚¹ãƒˆåã§æ¤œç´¢...">
            <button onclick="filterQuests()">çµã‚Šè¾¼ã¿</button>
            <button onclick="resetQuestFilter()" class="btn-secondary">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
          <div id="questManagementList">
            <p class="loading">èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        </div>

        <!-- ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ã‚¿ãƒ– -->
        <div id="membersTab" class="tab-content" style="display: none;">
          <h3>ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h3>
          <div class="filter-bar">
            <select id="memberStatusFilter">
              <option value="">ã™ã¹ã¦</option>
              <option value="æ‰¿èª">æ´»å‹•ä¸­</option>
              <option value="åœæ­¢">åœæ­¢ä¸­</option>
            </select>
            <input type="text" id="memberSearchInput" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã§æ¤œç´¢...">
            <button onclick="filterMembers()">çµã‚Šè¾¼ã¿</button>
            <button onclick="resetMemberFilter()" class="btn-secondary">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
          <div id="memberManagementList">
            <p class="loading">èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        </div>

        <!-- ä¾é ¼ä¸»ç®¡ç†ã‚¿ãƒ– -->
        <div id="clientsTab" class="tab-content" style="display: none;">
          <h3>ğŸ“‹ ä¾é ¼ä¸»ç®¡ç†</h3>
          <div class="filter-bar">
            <input type="text" id="clientSearchInput" placeholder="ä¾é ¼ä¸»åã§æ¤œç´¢...">
            <button onclick="filterClients()">çµã‚Šè¾¼ã¿</button>
            <button onclick="resetClientFilter()" class="btn-secondary">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
          <div id="clientManagementList">
            <p class="loading">èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        </div>

        <!-- å ±é…¬æ”¯æ‰•ç®¡ç†ã‚¿ãƒ– -->
        <div id="paymentTab" class="tab-content" style="display: none;">
          <h3>ğŸ’° å ±é…¬æ”¯æ‰•ç®¡ç†</h3>
          
          <h4>æ”¯æ‰•äºˆå®š</h4>
          <div id="paymentPendingList">
            <p class="loading">èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>

          <h4>æ”¯æ‰•å®Œäº†</h4>
          <div id="paymentCompletedList">
            <p class="loading">èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        </div>

        <!-- å ±å‘Šãƒ»å•é¡Œå¯¾å¿œã‚¿ãƒ– -->
        <div id="reportsTab" class="tab-content" style="display: none;">
          <h3>âš ï¸ å ±å‘Šãƒ»å•é¡Œå¯¾å¿œ</h3>
          <div id="reportsList">
            <p class="loading">èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2026 ç·ç¤¾å¸‚ã‚®ãƒ«ãƒ‰äº‹å‹™å±€ | ã‚ãã‚ãã‚®ãƒ«ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

<script src="js/config.js"></script>
<script>
  let adminData = {
    members: [],
    clients: [],
    quests: [],
    payments: [],
    reports: []
  };

  /**
   * æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
   */
  function formatDate(dateString) {
    if (!dateString) return '-';
    
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return '-';
      
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hour = String(date.getHours()).padStart(2, '0');
      const minute = String(date.getMinutes()).padStart(2, '0');
      
      return `${year}å¹´${month}æœˆ${day}æ—¥ ${hour}:${minute}`;
    } catch (error) {
      return '-';
    }
  }

  function formatDateOnly(dateString) {
    if (!dateString) return '-';
    
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return '-';
      
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      
      return `${year}å¹´${month}æœˆ${day}æ—¥`;
    } catch (error) {
      return '-';
    }
  }

  function escapeHtml(text) {
    if (!text) return '';
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, m => map[m]);
  }

  function getStatusClass(status) {
    const map = {
      'å‹Ÿé›†ä¸­': 'active',
      'å—æ³¨æ¸ˆ': 'progress',
      'é€²è¡Œä¸­': 'progress',
      'å®Œäº†': 'active',
      'ã‚­ãƒ£ãƒ³ã‚»ãƒ«': 'warning'
    };
    return map[status] || 'warning';
  }

  /**
   * ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
   */
  function handleAdminLogin(event) {
    event.preventDefault();
    
    const adminId = document.getElementById('adminId').value;
    const password = document.getElementById('adminPassword').value;
    
    if (adminId && password) {
      document.getElementById('adminLogin').style.display = 'none';
      document.getElementById('adminLoading').style.display = 'block';
      loadAdminData();
    } else {
      alert('IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    }
  }

  /**
   * ç®¡ç†ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
   */
  async function loadAdminData() {
    try {
      const statsResponse = await fetch(`${GAS_WEB_APP_URL}?action=getAdminStats`);
      const stats = await statsResponse.json();
      
      document.getElementById('statPending').textContent = `${stats.pendingTotal}ä»¶`;
      document.getElementById('statPendingDetail').textContent = 
        `ãƒ¡ãƒ³ãƒãƒ¼: ${stats.pendingMembers}ä»¶ / ä¾é ¼ä¸»: ${stats.pendingClients}ä»¶ / ã‚¯ã‚¨ã‚¹ãƒˆ: ${stats.pendingQuests}ä»¶`;
      document.getElementById('statInProgress').textContent = `${stats.inProgress}ä»¶`;
      document.getElementById('statCompleted').textContent = `${stats.completed}ä»¶`;
      document.getElementById('statDeposit').textContent = `Â¥${stats.deposit.toLocaleString()}`;

      await Promise.all([
        loadApprovalData(),
        loadQuestManagement(),
        loadMemberManagement(),
        loadClientManagement(),
        loadPaymentManagement(),
        loadReports()
      ]);

      document.getElementById('adminLoading').style.display = 'none';
      document.getElementById('adminDashboard').style.display = 'block';
    } catch (error) {
      console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      document.getElementById('adminLoading').style.display = 'none';
      document.getElementById('adminLogin').style.display = 'block';
    }
  }

  /**
   * å¯©æŸ»å¾…ã¡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
   */
  async function loadApprovalData() {
    try {
      const response = await fetch(`${GAS_WEB_APP_URL}?action=getApprovalData`);
      const data = await response.json();

      const memberList = document.getElementById('memberApprovalList');
      if (data.members && data.members.length > 0) {
        memberList.innerHTML = createApprovalTable(data.members, 'member');
      } else {
        memberList.innerHTML = '<p class="no-data">å¯©æŸ»å¾…ã¡ã®ãƒ¡ãƒ³ãƒãƒ¼ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
      }

      const clientList = document.getElementById('clientApprovalList');
      if (data.clients && data.clients.length > 0) {
        clientList.innerHTML = createApprovalTable(data.clients, 'client');
      } else {
        clientList.innerHTML = '<p class="no-data">å¯©æŸ»å¾…ã¡ã®ä¾é ¼ä¸»ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
      }

      const questList = document.getElementById('questApprovalList');
      if (data.quests && data.quests.length > 0) {
        questList.innerHTML = createApprovalTable(data.quests, 'quest');
      } else {
        questList.innerHTML = '<p class="no-data">å¯©æŸ»å¾…ã¡ã®ã‚¯ã‚¨ã‚¹ãƒˆæŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
      }
    } catch (error) {
      console.error('å¯©æŸ»ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  /**
   * å¯©æŸ»ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
   */
  function createApprovalTable(items, type) {
    let html = '<table class="admin-table"><thead><tr>';
    
    if (type === 'member') {
      html += '<th>ID</th><th>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </th><th>æ°å</th><th>é€£çµ¡å…ˆ</th><th>ç”³è«‹æ—¥</th><th>æ“ä½œ</th>';
    } else if (type === 'client') {
      html += '<th>ID</th><th>ä¾é ¼ä¸»å</th><th>ç¨®åˆ¥</th><th>é€£çµ¡å…ˆ</th><th>ç”³è«‹æ—¥</th><th>æ“ä½œ</th>';
    } else if (type === 'quest') {
      html += '<th>ID</th><th>ã‚¯ã‚¨ã‚¹ãƒˆå</th><th>ä¾é ¼ä¸»</th><th>å ±é…¬</th><th>æŠ•ç¨¿æ—¥</th><th>æ“ä½œ</th>';
    }
    
    html += '</tr></thead><tbody>';
    
    items.forEach(item => {
      html += '<tr>';
      if (type === 'member') {
        html += `
          <td>${item.id}</td>
          <td>${escapeHtml(item.nickname)}</td>
          <td>${escapeHtml(item.name)}</td>
          <td>${escapeHtml(item.email)}</td>
          <td>${formatDate(item.registeredDate)}</td>
          <td>
            <button onclick="approve('member', '${item.id}')" class="btn-approve">æ‰¿èª</button>
            <button onclick="reject('member', '${item.id}')" class="btn-reject">å´ä¸‹</button>
            <button onclick="viewDetail('member', '${item.id}')" class="btn-secondary">è©³ç´°</button>
          </td>
        `;
      } else if (type === 'client') {
        html += `
          <td>${item.id}</td>
          <td>${escapeHtml(item.name)}</td>
          <td>${escapeHtml(item.type)}</td>
          <td>${escapeHtml(item.email)}</td>
          <td>${formatDate(item.registeredDate)}</td>
          <td>
            <button onclick="approve('client', '${item.id}')" class="btn-approve">æ‰¿èª</button>
            <button onclick="reject('client', '${item.id}')" class="btn-reject">å´ä¸‹</button>
            <button onclick="viewDetail('client', '${item.id}')" class="btn-secondary">è©³ç´°</button>
          </td>
        `;
      } else if (type === 'quest') {
        html += `
          <td>${item.id}</td>
          <td>${escapeHtml(item.title)}</td>
          <td>${item.clientId}</td>
          <td>Â¥${item.reward.toLocaleString()}</td>
          <td>${formatDate(item.registeredDate)}</td>
          <td>
            <button onclick="approve('quest', '${item.id}')" class="btn-approve">æ‰¿èª</button>
            <button onclick="reject('quest', '${item.id}')" class="btn-reject">å´ä¸‹</button>
            <button onclick="viewDetail('quest', '${item.id}')" class="btn-secondary">è©³ç´°</button>
          </td>
        `;
      }
      html += '</tr>';
    });
    
    html += '</tbody></table>';
    return html;
  }

  /**
   * ã‚¯ã‚¨ã‚¹ãƒˆç®¡ç†
   */
  async function loadQuestManagement() {
    try {
      const response = await fetch(`${GAS_WEB_APP_URL}?action=getAllQuests`);
      const quests = await response.json();
      adminData.quests = quests;
      displayQuests(quests);
    } catch (error) {
      console.error('ã‚¯ã‚¨ã‚¹ãƒˆç®¡ç†ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  function displayQuests(quests) {
    const container = document.getElementById('questManagementList');
    
    if (!quests || quests.length === 0) {
      container.innerHTML = '<p class="no-data">ã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
      return;
    }

    let html = '<table class="admin-table"><thead><tr>';
    html += '<th>ID</th><th>ã‚¯ã‚¨ã‚¹ãƒˆå</th><th>ä¾é ¼ä¸»</th><th>å—æ³¨è€…</th><th>å ±é…¬</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>æ“ä½œ</th>';
    html += '</tr></thead><tbody>';

    quests.forEach(quest => {
      html += `
        <tr>
          <td>${quest.id}</td>
          <td>${escapeHtml(quest.title)}</td>
          <td>${quest.clientId}</td>
          <td>${quest.acceptorId || '-'}</td>
          <td>Â¥${quest.reward.toLocaleString()}</td>
          <td><span class="status-badge status-${getStatusClass(quest.publicStatus)}">${quest.publicStatus}</span></td>
          <td>
            <button onclick="viewDetail('quest', '${quest.id}')" class="btn-secondary">è©³ç´°</button>
          </td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  /**
   * ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†
   */
  async function loadMemberManagement() {
    try {
      const response = await fetch(`${GAS_WEB_APP_URL}?action=getAllMembers`);
      const members = await response.json();
      adminData.members = members;
      displayMembers(members);
    } catch (error) {
      console.error('ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  function displayMembers(members) {
    const container = document.getElementById('memberManagementList');
    
    if (!members || members.length === 0) {
      container.innerHTML = '<p class="no-data">ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</p>';
      return;
    }

    let html = '<table class="admin-table"><thead><tr>';
    html += '<th>ID</th><th>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </th><th>ãƒ©ãƒ³ã‚¯</th><th>çµŒé¨“å€¤</th><th>å®Œäº†æ•°</th><th>è©•ä¾¡</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>æ“ä½œ</th>';
    html += '</tr></thead><tbody>';

    members.forEach(member => {
      html += `
        <tr>
          <td>${member.id}</td>
          <td>${escapeHtml(member.nickname)}</td>
          <td><span class="rank-badge rank-${member.rank}">${member.rank}</span></td>
          <td>${member.exp}</td>
          <td>${member.completedQuests}</td>
          <td>â­${member.rating > 0 ? member.rating.toFixed(1) : '-'}</td>
          <td><span class="status-badge status-${member.status === 'æ‰¿èª' ? 'active' : 'warning'}">${member.status}</span></td>
          <td>
            <button onclick="viewDetail('member', '${member.id}')" class="btn-secondary">è©³ç´°</button>
            ${member.status === 'æ‰¿èª' ? 
              `<button onclick="suspendMember('${member.id}')" class="btn-warning">åœæ­¢</button>` :
              `<button onclick="activateMember('${member.id}')" class="btn-approve">å†é–‹</button>`
            }
          </td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  /**
   * ä¾é ¼ä¸»ç®¡ç†
   */
  async function loadClientManagement() {
    try {
      const response = await fetch(`${GAS_WEB_APP_URL}?action=getAllClients`);
      const clients = await response.json();
      adminData.clients = clients;
      displayClients(clients);
    } catch (error) {
      console.error('ä¾é ¼ä¸»ç®¡ç†ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  function displayClients(clients) {
    const container = document.getElementById('clientManagementList');
    
    if (!clients || clients.length === 0) {
      container.innerHTML = '<p class="no-data">ä¾é ¼ä¸»ãŒã„ã¾ã›ã‚“</p>';
      return;
    }

    let html = '<table class="admin-table"><thead><tr>';
    html += '<th>ID</th><th>ä¾é ¼ä¸»å</th><th>ç¨®åˆ¥</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>æ“ä½œ</th>';
    html += '</tr></thead><tbody>';

    clients.forEach(client => {
      html += `
        <tr>
          <td>${client.id}</td>
          <td>${escapeHtml(client.name)}</td>
          <td>${escapeHtml(client.type)}</td>
          <td><span class="status-badge status-${client.status === 'æ‰¿èª' ? 'active' : 'warning'}">${client.status}</span></td>
          <td>
            <button onclick="viewDetail('client', '${client.id}')" class="btn-secondary">è©³ç´°</button>
          </td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  /**
   * æ”¯æ‰•ç®¡ç†
   */
  async function loadPaymentManagement() {
    try {
      const response = await fetch(`${GAS_WEB_APP_URL}?action=getPaymentData`);
      const data = await response.json();
      
      const pendingList = document.getElementById('paymentPendingList');
      if (data.pending && data.pending.length > 0) {
        pendingList.innerHTML = createPaymentTable(data.pending, 'pending');
      } else {
        pendingList.innerHTML = '<p class="no-data">æ”¯æ‰•äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>';
      }

      const completedList = document.getElementById('paymentCompletedList');
      if (data.completed && data.completed.length > 0) {
        completedList.innerHTML = createPaymentTable(data.completed, 'completed');
      } else {
        completedList.innerHTML = '<p class="no-data">æ”¯æ‰•å®Œäº†ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
      }
    } catch (error) {
      console.error('æ”¯æ‰•ç®¡ç†ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  function createPaymentTable(items, type) {
    let html = '<table class="admin-table"><thead><tr>';
    html += '<th>æ”¯æ‰•ID</th><th>ã‚¯ã‚¨ã‚¹ãƒˆID</th><th>å—æ³¨è€…</th><th>å ±é…¬ç·é¡</th><th>æºæ³‰å¾´å</th><th>å·®å¼•æ”¯æ‰•é¡</th>';
    
    if (type === 'pending') {
      html += '<th>æ”¯æ‰•äºˆå®šæ—¥</th><th>æ“ä½œ</th>';
    } else {
      html += '<th>æ”¯æ‰•å®Œäº†æ—¥</th>';
    }
    
    html += '</tr></thead><tbody>';

    items.forEach(item => {
      html += `
        <tr>
          <td>${item.paymentId}</td>
          <td>${item.questId}</td>
          <td>${escapeHtml(item.acceptorName)}</td>
          <td>Â¥${item.totalAmount.toLocaleString()}</td>
          <td>Â¥${item.taxAmount.toLocaleString()}</td>
          <td>Â¥${item.netAmount.toLocaleString()}</td>
      `;
      
      if (type === 'pending') {
        html += `
          <td>${formatDate(item.scheduledDate)}</td>
          <td>
            <button onclick="processPayment('${item.paymentId}')" class="btn-approve">æ”¯æ‰•å®Ÿè¡Œ</button>
            <button onclick="viewPaymentDetail('${item.paymentId}')" class="btn-secondary">è©³ç´°</button>
          </td>
        `;
      } else {
        html += `<td>${formatDate(item.completedDate)}</td>`;
      }
      
      html += '</tr>';
    });

    html += '</tbody></table>';
    return html;
  }

  /**
   * å ±å‘Šç®¡ç†
   */
  async function loadReports() {
    try {
      const response = await fetch(`${GAS_WEB_APP_URL}?action=getReports`);
      const reports = await response.json();
      
      const container = document.getElementById('reportsList');
      
      if (!reports || reports.length === 0) {
        container.innerHTML = '<p class="no-data">å ±å‘Šã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      let html = '<table class="admin-table"><thead><tr>';
      html += '<th>å ±å‘ŠID</th><th>ã‚¯ã‚¨ã‚¹ãƒˆID</th><th>å ±å‘Šè€…</th><th>ç¨®åˆ¥</th><th>å†…å®¹</th><th>å ±å‘Šæ—¥</th><th>å¯¾å¿œçŠ¶æ³</th><th>æ“ä½œ</th>';
      html += '</tr></thead><tbody>';

      reports.forEach(report => {
        html += `
          <tr>
            <td>${report.id}</td>
            <td>${report.questId}</td>
            <td>${report.reporter}</td>
            <td>${report.type}</td>
            <td>${escapeHtml(report.content).substring(0, 30)}...</td>
            <td>${formatDate(report.reportDate)}</td>
            <td><span class="status-badge status-${report.status === 'æœªå¯¾å¿œ' ? 'warning' : 'active'}">${report.status}</span></td>
            <td>
              ${report.status === 'æœªå¯¾å¿œ' ? 
                `<button onclick="handleReport('${report.id}')" class="btn-primary">å¯¾å¿œã™ã‚‹</button>` :
                `<button onclick="viewReportDetail('${report.id}')" class="btn-secondary">è©³ç´°</button>`
              }
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    } catch (error) {
      console.error('å ±å‘Šãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  /**
   * ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
   */
  function showAdminTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

    const tabMap = {
      'approval': 'approvalTab',
      'quests': 'questsTab',
      'members': 'membersTab',
      'clients': 'clientsTab',
      'payment': 'paymentTab',
      'reports': 'reportsTab'
    };

    document.getElementById(tabMap[tabName]).style.display = 'block';
    event.target.classList.add('active');
  }

  /**
   * æ‰¿èªãƒ»å´ä¸‹å‡¦ç†
   */
  async function approve(type, id) {
    if (!confirm(`${type === 'member' ? 'ãƒ¡ãƒ³ãƒãƒ¼' : type === 'client' ? 'ä¾é ¼ä¸»' : 'ã‚¯ã‚¨ã‚¹ãƒˆ'}ã€${id}ã€‘ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ`)) {
      return;
    }

    try {
      const response = await fetch(GAS_WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' }, // â˜…è¿½åŠ 
        body: JSON.stringify({
          action: 'approve',
          type: type,
          id: id
        })
      });

      const result = await response.json();
      
      if (result.success) {
        alert('âœ… ' + result.message);
        await loadApprovalData();
      } else {
        alert('âŒ æ‰¿èªã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
      }
    } catch (error) {
      console.error('æ‰¿èªã‚¨ãƒ©ãƒ¼:', error);
      alert('âŒ æ‰¿èªå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  }

  async function reject(type, id) {
    const reason = prompt('å´ä¸‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
    if (!reason) return;

    try {
      const response = await fetch(GAS_WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' }, // â˜…è¿½åŠ 
        body: JSON.stringify({
          action: 'reject',
          type: type,
          id: id,
          reason: reason
        })
      });

      const result = await response.json();
      
      if (result.success) {
        alert('âœ… ' + result.message);
        await loadApprovalData();
      } else {
        alert('âŒ å´ä¸‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
      }
    } catch (error) {
      console.error('å´ä¸‹ã‚¨ãƒ©ãƒ¼:', error);
      alert('âŒ å´ä¸‹å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  }

  /**
   * ãƒ¡ãƒ³ãƒãƒ¼åœæ­¢ãƒ»å†é–‹
   */
  async function suspendMember(id) {
    if (!confirm(`ãƒ¡ãƒ³ãƒãƒ¼ã€${id}ã€‘ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ`)) return;

    try {
      const response = await fetch(GAS_WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
          action: 'suspendMember',
          id: id
        })
      });

      const result = await response.json();
      
      if (result.success) {
        alert('âœ… ãƒ¡ãƒ³ãƒãƒ¼ã‚’åœæ­¢ã—ã¾ã—ãŸ');
        await loadMemberManagement();
      } else {
        alert('âŒ åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
      }
    } catch (error) {
      console.error('åœæ­¢ã‚¨ãƒ©ãƒ¼:', error);
      alert('âŒ åœæ­¢å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  }

  async function activateMember(id) {
    if (!confirm(`ãƒ¡ãƒ³ãƒãƒ¼ã€${id}ã€‘ã‚’å†é–‹ã—ã¾ã™ã‹ï¼Ÿ`)) return;

    try {
      const response = await fetch(GAS_WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
          action: 'activateMember',
          id: id
        })
      });

      const result = await response.json();
      
      if (result.success) {
        alert('âœ… ãƒ¡ãƒ³ãƒãƒ¼ã‚’å†é–‹ã—ã¾ã—ãŸ');
        await loadMemberManagement();
      } else {
        alert('âŒ å†é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
      }
    } catch (error) {
      console.error('å†é–‹ã‚¨ãƒ©ãƒ¼:', error);
      alert('âŒ å†é–‹å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  }

  /**
   * æ”¯æ‰•å‡¦ç†
   */
  async function processPayment(paymentId) {
    if (!confirm(`æ”¯æ‰•ã€${paymentId}ã€‘ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) return;

    try {
      const response = await fetch(GAS_WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
          action: 'processPayment',
          paymentId: paymentId
        })
      });

      const result = await response.json();
      
      if (result.success) {
        alert('âœ… æ”¯æ‰•å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ');
        await loadPaymentManagement();
      } else {
        alert('âŒ æ”¯æ‰•å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
      }
    } catch (error) {
      console.error('æ”¯æ‰•å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
      alert('âŒ æ”¯æ‰•å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  }

  /**
   * å ±å‘Šå‡¦ç†
   */
  async function handleReport(reportId) {
    const action = prompt('å¯¾å¿œå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
    if (!action) return;

    try {
      const response = await fetch(GAS_WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
          action: 'handleReport',
          reportId: reportId,
          actionTaken: action
        })
      });

      const result = await response.json();
      
      if (result.success) {
        alert('âœ… å ±å‘Šã‚’å‡¦ç†ã—ã¾ã—ãŸ');
        await loadReports();
      } else {
        alert('âŒ å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
      }
    } catch (error) {
      console.error('å ±å‘Šå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
      alert('âŒ å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  }

  /**
   * ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½
   */
  function filterQuests() {
    const status = document.getElementById('questStatusFilter').value;
    const search = document.getElementById('questSearchInput').value.toLowerCase();
    
    const filtered = adminData.quests.filter(quest => {
      let match = true;
      if (status && quest.publicStatus !== status) match = false;
      if (search && !quest.title.toLowerCase().includes(search)) match = false;
      return match;
    });
    
    displayQuests(filtered);
  }

  function resetQuestFilter() {
    document.getElementById('questStatusFilter').value = '';
    document.getElementById('questSearchInput').value = '';
    displayQuests(adminData.quests);
  }

  function filterMembers() {
    const status = document.getElementById('memberStatusFilter').value;
    const search = document.getElementById('memberSearchInput').value.toLowerCase();
    
    const filtered = adminData.members.filter(member => {
      let match = true;
      if (status && member.status !== status) match = false;
      if (search && !member.nickname.toLowerCase().includes(search)) match = false;
      return match;
    });
    
    displayMembers(filtered);
  }

  function resetMemberFilter() {
    document.getElementById('memberStatusFilter').value = '';
    document.getElementById('memberSearchInput').value = '';
    displayMembers(adminData.members);
  }

  function filterClients() {
    const search = document.getElementById('clientSearchInput').value.toLowerCase();
    
    const filtered = adminData.clients.filter(client => {
      return client.name.toLowerCase().includes(search);
    });
    
    displayClients(filtered);
  }

  function resetClientFilter() {
    document.getElementById('clientSearchInput').value = '';
    displayClients(adminData.clients);
  }

  /**
   * ãã®ä»–
   */
  function viewDetail(type, id) {
    alert(`${type}ã®è©³ç´°æƒ…å ±è¡¨ç¤ºæ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™\nID: ${id}`);
  }

  function viewPaymentDetail(paymentId) {
    alert(`æ”¯æ‰•è©³ç´°è¡¨ç¤ºæ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™\næ”¯æ‰•ID: ${paymentId}`);
  }

  function viewReportDetail(reportId) {
    alert(`å ±å‘Šè©³ç´°è¡¨ç¤ºæ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™\nå ±å‘ŠID: ${reportId}`);
  }

  function logout() {
    if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
      location.reload();
    }
  }
</script>
</body>
</html>
