<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´° - ã‚ãã‚ãã‚®ãƒ«ãƒ‰</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <div class="container">
      <h1>âš”ï¸ ã‚ãã‚ãã‚®ãƒ«ãƒ‰</h1>
      <nav>
        <a href="index.html">ã‚¯ã‚¨ã‚¹ãƒˆæ²ç¤ºæ¿</a>
        <a href="ranking.html">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
        <a href="member.html">ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²</a>
        <a href="client.html">ä¾é ¼ä¸»ç™»éŒ²</a>
        <a href="mypage.html">ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="container quest-detail-section">
      <div class="breadcrumb">
        <a href="index.html">ã‚¯ã‚¨ã‚¹ãƒˆæ²ç¤ºæ¿</a> &gt; ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°
      </div>

      <!-- ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°ã‚«ãƒ¼ãƒ‰ -->
      <div id="questDetail" class="quest-detail-card">
        <div class="loading">ğŸ”„ èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>

      <!-- å—æ³¨ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="action-section">
        <h3>ğŸ¯ ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’å—æ³¨ã™ã‚‹</h3>
        
        <form id="acceptForm" class="accept-form">
          <div class="form-group">
            <label>ãƒ¡ãƒ³ãƒãƒ¼ID <span class="required">*</span></label>
            <input type="text" id="memberId" name="memberId" required placeholder="ä¾‹: M0001">
            <small>ç™»éŒ²æ™‚ã«ç™ºè¡Œã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
          </div>

          <!-- äººæ•°å…¥åŠ›æ¬„ï¼ˆæ³•äººã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
          <div class="form-group" id="participantCountGroup" style="display: none;">
            <label>å‚åŠ äººæ•° <span class="required">*</span></label>
            <input type="number" id="participantCount" name="participantCount" min="1" value="1">
            <small id="participantCountHelp">å‚åŠ ã™ã‚‹äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
          </div>

          <div class="form-group">
            <label>å¿œå‹Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="message" name="message" rows="4" placeholder="ä¾é ¼ä¸»ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
          </div>

          <button type="submit" class="btn-primary">ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’å—æ³¨ã™ã‚‹ âš”ï¸</button>
        </form>
      </div>

      <!-- æ³¨æ„äº‹é … -->
      <div class="info-box">
        <h3>âš ï¸ å—æ³¨å‰ã®ç¢ºèªäº‹é …</h3>
        <ul>
          <li>ã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’ã‚ˆãç¢ºèªã—ã¦ãã ã•ã„</li>
          <li>æ¨å¥¨ãƒ©ãƒ³ã‚¯æœªæº€ã§ã‚‚å—æ³¨å¯èƒ½ã§ã™ãŒã€é›£æ˜“åº¦ã‚’è€ƒæ…®ã—ã¦ãã ã•ã„</li>
          <li>å—æ³¨å¾Œã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ãƒ©ãƒ³ã‚¯ãƒ€ã‚¦ãƒ³ã®å¯¾è±¡ã¨ãªã‚Šã¾ã™</li>
          <li>ä½œæ¥­å®Œäº†å¾Œã¯é€Ÿã‚„ã‹ã«å®Œäº†å ±å‘Šã‚’è¡Œã£ã¦ãã ã•ã„</li>
          <li><strong>æ³•äººãƒ¦ãƒ¼ã‚¶ãƒ¼:</strong> å‚åŠ äººæ•°ã‚’æŒ‡å®šã—ã¦å—æ³¨ã§ãã¾ã™ï¼ˆæ®‹ã‚Šå‹Ÿé›†äººæ•°ã®ç¯„å›²å†…ï¼‰</li>
          <li><strong>å€‹äººãƒ¦ãƒ¼ã‚¶ãƒ¼:</strong> å¸¸ã«1åå˜ä½ã§ã®å—æ³¨ã¨ãªã‚Šã¾ã™</li>
        </ul>
      </div>
    </div>
  </main>

  <footer>
    <p>Â© 2026 ç·ç¤¾å¸‚ã‚®ãƒ«ãƒ‰äº‹å‹™å±€ | ã‚ãã‚ãã‚®ãƒ«ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

  <script src="js/config.js"></script>
  <script>
    let questData = null;
    let memberData = null;

    function initializePage() {
      loadQuestDetail();
      setupMemberIdInput();
    }

    /**
     * ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°ã‚’èª­ã¿è¾¼ã‚€
     */
    async function loadQuestDetail() {
      const urlParams = new URLSearchParams(window.location.search);
      const questId = urlParams.get('id');
      
      if (!questId) {
        document.getElementById('questDetail').innerHTML = 
          '<div class="error">âŒ ã‚¯ã‚¨ã‚¹ãƒˆIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        return;
      }
      
      try {
        questData = await API.get('getQuestDetail', { id: questId });
        
        if (questData.error) {
          document.getElementById('questDetail').innerHTML = 
            `<div class="error">âŒ ${questData.message}</div>`;
          return;
        }
        
        displayQuestDetail(questData);
      } catch (error) {
        console.error('ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('questDetail').innerHTML = 
          '<div class="error">âŒ ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }

/**
 * ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°ã‚’è¡¨ç¤º
 */
function displayQuestDetail(quest) {
  const difficulty = DIFFICULTIES[quest.difficulty] || DIFFICULTIES[3];
  
  // â˜…å ±é…¬è¨ˆç®—ã‚’è¿½åŠ 
  const totalReward = Number(quest.reward);
  const requiredMembers = Number(quest.requiredMembers);
  const rewardPerPerson = Math.floor(totalReward / requiredMembers);
  
  const html = `
    <div class="quest-detail-header">
      <h2>${quest.title}</h2>
      <div class="quest-meta">
        <div class="difficulty-large" title="${difficulty.label}">${difficulty.stars}</div>
        <div class="recommend-rank">æ¨å¥¨ãƒ©ãƒ³ã‚¯: ${quest.recommendRank}</div>
        ${Utils.getCategoryBadge(quest.category)}
      </div>
    </div>
    
    <div class="quest-detail-body">
      <div class="detail-section">
        <h3>ğŸ“‹ åŸºæœ¬æƒ…å ±</h3>
        <table class="detail-table">
          <tr>
            <th>ä¾é ¼ä¸»</th>
            <td>${quest.clientName}</td>
          </tr>
          <tr>
            <th>å®Ÿæ–½å ´æ‰€</th>
            <td>${quest.location}</td>
          </tr>
          <tr>
            <th>å¸Œæœ›æ—¥æ™‚</th>
            <td>${Utils.formatDate(quest.desiredDate)}</td>
          </tr>
          <tr>
            <th>æ‰€è¦æ™‚é–“</th>
            <td>${quest.estimatedHours}</td>
          </tr>
          <tr>
            <th>å‹Ÿé›†äººæ•°</th>
            <td>${quest.requiredMembers}å</td>
          </tr>
        </table>
      </div>

      <div class="detail-section">
        <h3>ğŸ’° å ±é…¬</h3>
        
        <!-- â˜…å ±é…¬è¡¨ç¤ºã‚’æ”¹å–„ -->
        <div class="reward-display">
          <div class="reward-per-person">
            <div class="reward-label">1äººã‚ãŸã‚Šã®å ±é…¬</div>
            <div class="reward-amount-large">${Utils.formatCurrency(rewardPerPerson)}</div>
          </div>
          
          <div class="reward-total">
            <div class="reward-label-small">å ±é…¬ç·é¡</div>
            <div class="reward-amount-small">${Utils.formatCurrency(totalReward)}</div>
            <div class="reward-note">ï¼ˆ${requiredMembers}ååˆ†ï¼‰</div>
          </div>
        </div>
        
        <div class="tax-info">
          <p><strong>ğŸ’¡ æºæ³‰å¾´åã«ã¤ã„ã¦</strong></p>
          <table class="tax-table">
            <tr>
              <th>1äººã‚ãŸã‚Šå ±é…¬</th>
              <td>${Utils.formatCurrency(rewardPerPerson)}</td>
            </tr>
            <tr>
              <th>æºæ³‰å¾´åç¨ï¼ˆ10.21%ï¼‰</th>
              <td>- ${Utils.formatCurrency(Utils.calculateTax(rewardPerPerson))}</td>
            </tr>
            <tr class="tax-total">
              <th>æ‰‹å–ã‚Šé¡ï¼ˆ1äººã‚ãŸã‚Šï¼‰</th>
              <td><strong>${Utils.formatCurrency(Utils.calculateNetAmount(rewardPerPerson))}</strong></td>
            </tr>
          </table>
          <p class="tax-note">â€»æºæ³‰å¾´åç¨ã¯äº‹å‹™å±€ãŒç´ç¨ã—ã¾ã™</p>
        </div>
      </div>

      <div class="detail-section">
        <h3>ğŸ“ å†…å®¹è©³ç´°</h3>
        <div class="description-box">${quest.description}</div>
      </div>

      ${quest.equipment ? `
        <div class="detail-section">
          <h3>ğŸ› ï¸ å¿…è¦ãªé“å…·ãƒ»è£…å‚™</h3>
          <div class="equipment-box">${quest.equipment}</div>
        </div>
      ` : ''}

      ${quest.notes ? `
        <div class="detail-section">
          <h3>âš ï¸ æ³¨æ„äº‹é …ãƒ»å‚™è€ƒ</h3>
          <div class="notes-box">${quest.notes}</div>
        </div>
      ` : ''}

      <div class="detail-section">
        <h3>â­ ç²å¾—çµŒé¨“å€¤</h3>
        <div class="exp-info">
          ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Œäº†ã™ã‚‹ã¨ <strong>${difficulty.exp} EXP</strong> ã‚’ç²å¾—ã§ãã¾ã™
        </div>
      </div>
    </div>
  `;
  
  document.getElementById('questDetail').innerHTML = html;
}

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼IDå…¥åŠ›ã®ç›£è¦–
     */
    function setupMemberIdInput() {
      const memberIdInput = document.getElementById('memberId');
      
      if (!memberIdInput) {
        console.error('memberIdè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // blur ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸæ™‚ï¼‰
      memberIdInput.addEventListener('blur', async () => {
        const memberId = memberIdInput.value.trim();
        
        if (!memberId) return;
        
        await checkMemberType(memberId);
      });
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼ç¨®åˆ¥ã‚’ãƒã‚§ãƒƒã‚¯
     */
    async function checkMemberType(memberId) {
      try {
        const result = await API.get('getMemberType', { id: memberId });
        
        if (result.success) {
          memberData = result;
          updateParticipantCountField(result.userType, result.corporateName);
        } else {
          memberData = null;
          hideParticipantCountField();
          Notification.warning('ãƒ¡ãƒ³ãƒãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ­£ã—ã„IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        }
      } catch (error) {
        console.error('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        Notification.error('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        memberData = null;
      }
    }

    /**
     * å‚åŠ äººæ•°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤ºåˆ¶å¾¡
     */
    function updateParticipantCountField(userType, corporateName) {
      const participantCountGroup = document.getElementById('participantCountGroup');
      const participantCountInput = document.getElementById('participantCount');
      const participantCountHelp = document.getElementById('participantCountHelp');
      
      if (!participantCountGroup) {
        console.error('participantCountGroupè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      if (userType === 'æ³•äºº') {
        // æ³•äººã®å ´åˆ: äººæ•°å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
        participantCountGroup.style.display = 'block';
        participantCountInput.required = true;
        participantCountInput.value = 1;
        
        if (questData) {
          participantCountInput.max = questData.requiredMembers;
          participantCountHelp.innerHTML = `<strong>${corporateName}</strong>ã¨ã—ã¦å‚åŠ ã™ã‚‹äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæœ€å¤§${questData.requiredMembers}åï¼‰`;
        } else {
          participantCountHelp.innerHTML = `<strong>${corporateName}</strong>ã¨ã—ã¦å‚åŠ ã™ã‚‹äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
        }
        
        Notification.success(`æ³•äººãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${corporateName}ã€ã¨ã—ã¦èªè­˜ã•ã‚Œã¾ã—ãŸã€‚å‚åŠ äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`, 3000);
        
      } else {
        // å€‹äººã®å ´åˆ: äººæ•°å…¥åŠ›æ¬„ã‚’éè¡¨ç¤º
        participantCountGroup.style.display = 'none';
        participantCountInput.required = false;
        participantCountInput.value = 1;
        
        Notification.info('å€‹äººãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦èªè­˜ã•ã‚Œã¾ã—ãŸã€‚1åã§ã®å—æ³¨ã¨ãªã‚Šã¾ã™ã€‚', 3000);
      }
    }

    /**
     * å‚åŠ äººæ•°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éè¡¨ç¤º
     */
    function hideParticipantCountField() {
      const participantCountGroup = document.getElementById('participantCountGroup');
      if (participantCountGroup) {
        participantCountGroup.style.display = 'none';
      }
    }

    /**
     * å—æ³¨ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
     */
    document.getElementById('acceptForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const memberId = document.getElementById('memberId').value.trim();
      const participantCount = parseInt(document.getElementById('participantCount').value) || 1;
      
      if (!memberId) {
        Notification.error('ãƒ¡ãƒ³ãƒãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!memberData) {
        Notification.error('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ãã ã•ã„ï¼ˆãƒ¡ãƒ³ãƒãƒ¼IDå…¥åŠ›å¾Œã€ä»–ã®å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼‰');
        return;
      }
      
      // æ³•äººã®å ´åˆã®äººæ•°ãƒã‚§ãƒƒã‚¯
      if (memberData.userType === 'æ³•äºº') {
        if (participantCount < 1) {
          Notification.error('å‚åŠ äººæ•°ã¯1åä»¥ä¸Šã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
          return;
        }
        
        if (questData && participantCount > questData.requiredMembers) {
          Notification.error(`å‚åŠ äººæ•°ãŒå‹Ÿé›†äººæ•°ï¼ˆ${questData.requiredMembers}åï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™`);
          return;
        }
      }
      
      // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
      const userTypeText = memberData.userType === 'æ³•äºº' ? 
        `æ³•äººã€Œ${memberData.corporateName}ã€` : 'å€‹äºº';
      
      if (!confirm(`ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’å—æ³¨ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼ç¨®åˆ¥: ${userTypeText}\nå‚åŠ äººæ•°: ${participantCount}å`)) {
        return;
      }
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'é€ä¿¡ä¸­...';
      
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const questId = urlParams.get('id');
        
        const result = await API.post('acceptQuest', {
          questId: questId,
          memberId: memberId,
          participantCount: participantCount
        });
        
        if (result.success) {
          Notification.success('å—æ³¨ãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒã‚¤ãƒšãƒ¼ã‚¸ã§ç¢ºèªã§ãã¾ã™ã€‚', 0);
          setTimeout(() => {
            location.href = 'mypage.html';
          }, 2000);
        } else {
          Notification.error(result.message);
          submitBtn.disabled = false;
          submitBtn.textContent = 'ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’å—æ³¨ã™ã‚‹ âš”ï¸';
        }
      } catch (error) {
        console.error('å—æ³¨ã‚¨ãƒ©ãƒ¼:', error);
        Notification.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’å—æ³¨ã™ã‚‹ âš”ï¸';
      }
    });
  </script>
</body>
</html>