<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´° - ã‚ãã‚ãã‚®ãƒ«ãƒ‰</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .debug-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 5px;
    }
    .debug-box h4 {
      margin: 0 0 0.5rem 0;
      color: #856404;
    }
    .debug-box pre {
      background: #fff;
      padding: 0.5rem;
      border-radius: 3px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>âš”ï¸ ã‚ãã‚ãã‚®ãƒ«ãƒ‰</h1>
      <nav>
        <a href="index.html">ã‚¯ã‚¨ã‚¹ãƒˆæ²ç¤ºæ¿</a>
        <a href="ranking.html">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
        <a href="member.html">ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²</a>
        <a href="client.html">ä¾é ¼ä¸»ç™»éŒ²</a>
        <a href="mypage.html">ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="container quest-detail-section">
      <div class="breadcrumb">
        <a href="index.html">ã‚¯ã‚¨ã‚¹ãƒˆæ²ç¤ºæ¿</a> &gt; ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼‰
      </div>

      <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
      <div class="debug-box">
        <h4>ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h4>
        <div id="debugInfo">
          <p>ãƒ¡ãƒ³ãƒãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...</p>
        </div>
      </div>

      <!-- ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°ã‚«ãƒ¼ãƒ‰ -->
      <div id="questDetail" class="quest-detail-card">
        <div class="loading">ğŸ”„ èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>

      <!-- å—æ³¨ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="action-section">
        <h3>ğŸ¯ ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’å—æ³¨ã™ã‚‹ï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰</h3>
        
        <form id="acceptForm" class="accept-form">
          <div class="form-group">
            <label>ãƒ¡ãƒ³ãƒãƒ¼ID <span class="required">*</span></label>
            <input type="text" id="memberId" name="memberId" required placeholder="ä¾‹: M0004">
            <small>ç™»éŒ²æ™‚ã«ç™ºè¡Œã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
          </div>

          <!-- äººæ•°å…¥åŠ›æ¬„ï¼ˆå¸¸ã«è¡¨ç¤ºã—ã¦ãƒ†ã‚¹ãƒˆï¼‰ -->
          <div class="form-group" id="participantCountGroup">
            <label>å‚åŠ äººæ•° <span class="required">*</span></label>
            <input type="number" id="participantCount" name="participantCount" min="1" value="1">
            <small id="participantCountHelp">å‚åŠ ã™ã‚‹äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
            <div id="participantCountStatus" style="margin-top: 0.5rem; padding: 0.5rem; background: #f0f0f0; border-radius: 3px;">
              çŠ¶æ…‹: <strong>å¾…æ©Ÿä¸­</strong>
            </div>
          </div>

          <div class="form-group">
            <label>å¿œå‹Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="message" name="message" rows="4" placeholder="ä¾é ¼ä¸»ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
          </div>

          <button type="submit" class="btn-primary">ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’å—æ³¨ã™ã‚‹</button>
        </form>
      </div>

      <!-- æ³¨æ„äº‹é … -->
      <div class="info-box">
        <h3>âš ï¸ å—æ³¨å‰ã®ç¢ºèªäº‹é …</h3>
        <ul>
          <li>ã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’ã‚ˆãç¢ºèªã—ã¦ãã ã•ã„</li>
          <li>æ¨å¥¨ãƒ©ãƒ³ã‚¯æœªæº€ã§ã‚‚å—æ³¨å¯èƒ½ã§ã™ãŒã€é›£æ˜“åº¦ã‚’è€ƒæ…®ã—ã¦ãã ã•ã„</li>
          <li>å—æ³¨å¾Œã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ãƒ©ãƒ³ã‚¯ãƒ€ã‚¦ãƒ³ã®å¯¾è±¡ã¨ãªã‚Šã¾ã™</li>
          <li>ä½œæ¥­å®Œäº†å¾Œã¯é€Ÿã‚„ã‹ã«å®Œäº†å ±å‘Šã‚’è¡Œã£ã¦ãã ã•ã„</li>
          <li><strong>æ³•äººãƒ¦ãƒ¼ã‚¶ãƒ¼:</strong> å‚åŠ äººæ•°ã‚’æŒ‡å®šã—ã¦å—æ³¨ã§ãã¾ã™ï¼ˆæ®‹ã‚Šå‹Ÿé›†äººæ•°ã®ç¯„å›²å†…ï¼‰</li>
          <li><strong>å€‹äººãƒ¦ãƒ¼ã‚¶ãƒ¼:</strong> å¸¸ã«1åå˜ä½ã§ã®å—æ³¨ã¨ãªã‚Šã¾ã™</li>
        </ul>
      </div>
    </div>
  </main>

  <footer>
    <p>Â© 2026 ç·ç¤¾å¸‚ã‚®ãƒ«ãƒ‰äº‹å‹™å±€ | ã‚ãã‚ãã‚®ãƒ«ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

  <script src="js/config.js"></script>
  <script>
    let questData = null;
    let memberData = null;

    function initializePage() {
      console.log('ğŸš€ ãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–‹å§‹');
      loadQuestDetail();
      setupMemberIdInput();
    }

    /**
     * ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°ã‚’èª­ã¿è¾¼ã‚€
     */
    async function loadQuestDetail() {
      const urlParams = new URLSearchParams(window.location.search);
      const questId = urlParams.get('id');
      
      console.log('ğŸ“‹ ã‚¯ã‚¨ã‚¹ãƒˆID:', questId);
      
      if (!questId) {
        document.getElementById('questDetail').innerHTML = 
          '<div class="error">âŒ ã‚¯ã‚¨ã‚¹ãƒˆIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        return;
      }
      
      try {
        questData = await API.get('getQuestDetail', { id: questId });
        
        console.log('âœ… ã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—:', questData);
        
        if (questData.error) {
          document.getElementById('questDetail').innerHTML = 
            `<div class="error">âŒ ${questData.message}</div>`;
          return;
        }
        
        displayQuestDetail(questData);
      } catch (error) {
        console.error('âŒ ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('questDetail').innerHTML = 
          '<div class="error">âŒ ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }

    /**
     * ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°ã‚’è¡¨ç¤º
     */
    function displayQuestDetail(quest) {
      const difficulty = DIFFICULTIES[quest.difficulty] || DIFFICULTIES[3];
      
      const html = `
        <div class="quest-detail-header">
          <h2>${quest.title}</h2>
          <div class="quest-meta">
            <div class="difficulty-large">${difficulty.stars}</div>
            <div class="recommend-rank">æ¨å¥¨ãƒ©ãƒ³ã‚¯: ${quest.recommendRank}</div>
          </div>
        </div>
        
        <div class="quest-detail-body">
          <div class="detail-section">
            <h3>ğŸ“‹ åŸºæœ¬æƒ…å ±</h3>
            <table class="detail-table">
              <tr><th>ä¾é ¼ä¸»</th><td>${quest.clientName}</td></tr>
              <tr><th>å®Ÿæ–½å ´æ‰€</th><td>${quest.location}</td></tr>
              <tr><th>å¸Œæœ›æ—¥æ™‚</th><td>${Utils.formatDate(quest.desiredDate)}</td></tr>
              <tr><th>å‹Ÿé›†äººæ•°</th><td>${quest.requiredMembers}å</td></tr>
            </table>
          </div>

          <div class="detail-section">
            <h3>ğŸ’° å ±é…¬</h3>
            <div class="reward-amount">${Utils.formatCurrency(quest.reward)}</div>
          </div>

          <div class="detail-section">
            <h3>ğŸ“ å†…å®¹è©³ç´°</h3>
            <div class="description-box">${quest.description}</div>
          </div>
        </div>
      `;
      
      document.getElementById('questDetail').innerHTML = html;
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼IDå…¥åŠ›ã®ç›£è¦–
     */
    function setupMemberIdInput() {
      const memberIdInput = document.getElementById('memberId');
      
      console.log('ğŸ‘‚ ãƒ¡ãƒ³ãƒãƒ¼IDå…¥åŠ›ç›£è¦–ã‚’è¨­å®š');
      
      if (!memberIdInput) {
        console.error('âŒ memberIdè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // blur ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸæ™‚ï¼‰
      memberIdInput.addEventListener('blur', async () => {
        const memberId = memberIdInput.value.trim();
        
        console.log('ğŸ“ ãƒ¡ãƒ³ãƒãƒ¼IDå…¥åŠ›ï¼ˆblurï¼‰:', memberId);
        updateDebugInfo('ãƒ¡ãƒ³ãƒãƒ¼IDå…¥åŠ›: ' + memberId);
        
        if (!memberId) {
          updateDebugInfo('ãƒ¡ãƒ³ãƒãƒ¼IDãŒç©ºã§ã™');
          return;
        }
        
        await checkMemberType(memberId);
      });
      
      // input ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
      memberIdInput.addEventListener('input', () => {
        const memberId = memberIdInput.value.trim();
        console.log('âŒ¨ï¸ ãƒ¡ãƒ³ãƒãƒ¼IDå…¥åŠ›ä¸­:', memberId);
      });
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼ç¨®åˆ¥ã‚’ãƒã‚§ãƒƒã‚¯
     */
    async function checkMemberType(memberId) {
      updateDebugInfo('APIå‘¼ã³å‡ºã—é–‹å§‹...');
      
      try {
        console.log('ğŸŒ APIå‘¼ã³å‡ºã—: getMemberType, id=' + memberId);
        
        const result = await API.get('getMemberType', { id: memberId });
        
        console.log('ğŸ“¦ APIçµæœ:', result);
        updateDebugInfo('APIçµæœ: ' + JSON.stringify(result, null, 2));
        
        if (result.success) {
          memberData = result;
          console.log('âœ… ãƒ¡ãƒ³ãƒãƒ¼ç¨®åˆ¥:', result.userType);
          console.log('ğŸ¢ æ³•äººå:', result.corporateName);
          
          updateParticipantCountField(result.userType, result.corporateName);
        } else {
          console.log('âŒ ãƒ¡ãƒ³ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', result.message);
          updateDebugInfo('ã‚¨ãƒ©ãƒ¼: ' + result.message);
          memberData = null;
          hideParticipantCountField();
        }
      } catch (error) {
        console.error('âŒ APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
        updateDebugInfo('ã‚¨ãƒ©ãƒ¼: ' + error.toString());
        alert('âŒ ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.toString() + '\n\nGASãŒæ­£ã—ããƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        memberData = null;
      }
    }

    /**
     * å‚åŠ äººæ•°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤ºåˆ¶å¾¡
     */
    function updateParticipantCountField(userType, corporateName) {
      console.log('ğŸ›ï¸ updateParticipantCountField å‘¼ã³å‡ºã—');
      console.log('   userType:', userType);
      console.log('   corporateName:', corporateName);
      
      const participantCountGroup = document.getElementById('participantCountGroup');
      const participantCountInput = document.getElementById('participantCount');
      const participantCountHelp = document.getElementById('participantCountHelp');
      const participantCountStatus = document.getElementById('participantCountStatus');
      
      if (!participantCountGroup) {
        console.error('âŒ participantCountGroupè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      if (userType === 'æ³•äºº') {
        // æ³•äººã®å ´åˆ: äººæ•°å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
        console.log('ğŸ¢ æ³•äººãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œå‡º: äººæ•°å…¥åŠ›æ¬„ã‚’è¡¨ç¤º');
        
        participantCountGroup.style.display = 'block';
        participantCountGroup.style.background = '#e8f5e9';
        participantCountGroup.style.border = '2px solid #4caf50';
        participantCountGroup.style.padding = '1rem';
        participantCountGroup.style.borderRadius = '8px';
        
        participantCountInput.required = true;
        participantCountInput.value = 1;
        
        if (questData) {
          participantCountInput.max = questData.requiredMembers;
          participantCountHelp.innerHTML = `<strong>${corporateName}</strong>ã¨ã—ã¦å‚åŠ ã™ã‚‹äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæœ€å¤§${questData.requiredMembers}åï¼‰`;
        } else {
          participantCountHelp.innerHTML = `<strong>${corporateName}</strong>ã¨ã—ã¦å‚åŠ ã™ã‚‹äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
        }
        
        participantCountStatus.innerHTML = 'çŠ¶æ…‹: <strong style="color: #4caf50;">âœ… æ³•äººãƒ¦ãƒ¼ã‚¶ãƒ¼ - äººæ•°å…¥åŠ›å¯èƒ½</strong>';
        
        updateDebugInfo(`æ³•äººãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œå‡º: ${corporateName}\näººæ•°å…¥åŠ›æ¬„ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
        
      } else {
        // å€‹äººã®å ´åˆ: äººæ•°å…¥åŠ›æ¬„ã‚’éè¡¨ç¤º
        console.log('ğŸ‘¤ å€‹äººãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œå‡º: äººæ•°å…¥åŠ›æ¬„ã‚’éè¡¨ç¤º');
        
        participantCountGroup.style.display = 'none';
        participantCountInput.required = false;
        participantCountInput.value = 1;
        
        updateDebugInfo('å€‹äººãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œå‡º\näººæ•°ã¯è‡ªå‹•çš„ã«1åã«è¨­å®šã•ã‚Œã¾ã™');
      }
    }

    /**
     * å‚åŠ äººæ•°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éè¡¨ç¤º
     */
    function hideParticipantCountField() {
      const participantCountGroup = document.getElementById('participantCountGroup');
      if (participantCountGroup) {
        participantCountGroup.style.display = 'none';
      }
    }

    /**
     * ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°
     */
    function updateDebugInfo(message) {
      const debugInfo = document.getElementById('debugInfo');
      if (debugInfo) {
        const timestamp = new Date().toLocaleTimeString('ja-JP');
        debugInfo.innerHTML = `<pre>[${timestamp}] ${message}</pre>`;
      }
    }

    /**
     * å—æ³¨ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
     */
    document.getElementById('acceptForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const memberId = document.getElementById('memberId').value.trim();
      const participantCount = parseInt(document.getElementById('participantCount').value) || 1;
      
      console.log('ğŸ“¤ å—æ³¨é€ä¿¡:', { memberId, participantCount, memberData });
      
      if (!memberId) {
        alert('ãƒ¡ãƒ³ãƒãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!memberData) {
        alert('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ãã ã•ã„ï¼ˆãƒ¡ãƒ³ãƒãƒ¼IDå…¥åŠ›å¾Œã€ä»–ã®å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼‰');
        return;
      }
      
      // æ³•äººã®å ´åˆã®äººæ•°ãƒã‚§ãƒƒã‚¯
      if (memberData.userType === 'æ³•äºº') {
        if (participantCount < 1) {
          alert('å‚åŠ äººæ•°ã¯1åä»¥ä¸Šã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
          return;
        }
        
        if (questData && participantCount > questData.requiredMembers) {
          alert(`å‚åŠ äººæ•°ãŒå‹Ÿé›†äººæ•°ï¼ˆ${questData.requiredMembers}åï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™`);
          return;
        }
      }
      
      if (!confirm(`ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’å—æ³¨ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ¡ãƒ³ãƒãƒ¼ID: ${memberId}\nå‚åŠ äººæ•°: ${participantCount}å\nãƒ¦ãƒ¼ã‚¶ãƒ¼ç¨®åˆ¥: ${memberData.userType}`)) {
        return;
      }
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'é€ä¿¡ä¸­...';
      
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const questId = urlParams.get('id');
        
        const result = await API.post('acceptQuest', {
          questId: questId,
          memberId: memberId,
          participantCount: participantCount
        });
        
        console.log('âœ… å—æ³¨çµæœ:', result);
        
        if (result.success) {
          alert(`âœ… ${result.message}\n\nå—æ³¨ãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒã‚¤ãƒšãƒ¼ã‚¸ã§ç¢ºèªã§ãã¾ã™ã€‚`);
          location.href = 'mypage.html';
        } else {
          alert(`âŒ ${result.message}`);
        }
      } catch (error) {
        console.error('âŒ å—æ³¨ã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + error.toString());
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’å—æ³¨ã™ã‚‹';
      }
    });
  </script>
</body>
</html>