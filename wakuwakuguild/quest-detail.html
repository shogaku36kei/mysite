<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´° - ã‚ãã‚ãã‚®ãƒ«ãƒ‰</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* å‹Ÿé›†æ æƒ…å ±è¡¨ç¤º */
    .slot-info {
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      color: white;
    }

    .slot-display h4 {
      margin: 0 0 15px 0;
      font-size: 1.2em;
    }

    .slot-numbers {
      font-size: 2em;
      font-weight: bold;
      margin: 10px 0;
    }

    .slot-numbers .remaining {
      color: #ffd700;
      font-size: 1.3em;
    }

    .slot-note {
      margin: 10px 0 0 0;
      font-size: 0.9em;
      opacity: 0.9;
    }

    .slots-few .slot-info {
      background: linear-gradient(135deg, #e63946 0%, #c1121f 100%);
      animation: pulse 1.5s infinite;
    }

    .slots-medium .slot-info {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }

    #participantCountGroup {
      margin-top: 15px;
    }

    #rewardPreview {
      display: block;
      margin-top: 8px;
      padding: 10px;
      background: #f0f9ff;
      border-left: 4px solid #2563eb;
      border-radius: 4px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>âš”ï¸ ã‚ãã‚ãã‚®ãƒ«ãƒ‰</h1>
      <nav>
        <a href="index.html">ã‚¯ã‚¨ã‚¹ãƒˆæ²ç¤ºæ¿</a>
        <a href="ranking.html">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
        <a href="member.html">ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²</a>
        <a href="client.html">ä¾é ¼ä¸»ç™»éŒ²</a>
        <a href="mypage.html">ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="quest-detail-section">
      <div class="breadcrumb">
        <a href="index.html">ã‚¯ã‚¨ã‚¹ãƒˆæ²ç¤ºæ¿</a> &gt; <span>ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°</span>
      </div>

      <div id="questDetail" class="quest-detail-card">
        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
      </div>

      <div class="action-section">
        <h3>ğŸ¯ ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’å—æ³¨ã™ã‚‹</h3>
        
        <div id="questSlotInfo" class="slot-info">
          <!-- JavaScriptã§å‹•çš„ã«è¡¨ç¤º -->
        </div>
        
        <div class="accept-form">
          <div class="form-group">
            <label for="memberId">ãƒ¡ãƒ³ãƒãƒ¼ID <span style="color: red;">*</span></label>
            <input type="text" id="memberId" placeholder="ä¾‹: M0001" required>
          </div>

          <div class="form-group">
            <label for="acceptType">å—æ³¨ã‚¿ã‚¤ãƒ— <span style="color: red;">*</span></label>
            <select id="acceptType" required onchange="togglePartyInput()">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="å€‹äºº">å€‹äººï¼ˆ1åï¼‰</option>
              <option value="ãƒ‘ãƒ¼ãƒ†ã‚£">ãƒ‘ãƒ¼ãƒ†ã‚£ï¼ˆè¤‡æ•°åï¼‰</option>
            </select>
          </div>

          <div class="form-group" id="partyIdGroup" style="display: none;">
            <label for="partyId">ãƒ‘ãƒ¼ãƒ†ã‚£ID <span style="color: red;">*</span></label>
            <input type="text" id="partyId" placeholder="ä¾‹: P0001">
          </div>

          <div class="form-group" id="participantCountGroup" style="display: none;">
            <label for="participantCount">å‚åŠ äººæ•° <span style="color: red;">*</span></label>
            <input type="number" id="participantCount" min="1" max="10" value="1" onchange="updateRewardPreview()">
            <small id="rewardPreview"></small>
          </div>

          <div class="form-group">
            <label for="message">å¿œå‹Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="message" rows="4" placeholder="æ„æ°—è¾¼ã¿ã‚„è³ªå•ãªã©ã‚’ã”è¨˜å…¥ãã ã•ã„"></textarea>
          </div>

          <button onclick="acceptQuest()" class="btn-primary btn-large">ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’å—æ³¨ã™ã‚‹</button>
        </div>
      </div>

      <div class="info-box">
        <h3>âš ï¸ å—æ³¨å‰ã®ç¢ºèªäº‹é …</h3>
        <ul>
          <li>ã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’ã‚ˆãç¢ºèªã—ã¦ãã ã•ã„</li>
          <li>æ¨å¥¨ãƒ©ãƒ³ã‚¯æœªæº€ã§ã‚‚å—æ³¨å¯èƒ½ã§ã™ãŒã€é›£æ˜“åº¦ã‚’è€ƒæ…®ã—ã¦ãã ã•ã„</li>
          <li>å—æ³¨å¾Œã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ãƒ©ãƒ³ã‚¯ãƒ€ã‚¦ãƒ³ã®å¯¾è±¡ã¨ãªã‚Šã¾ã™</li>
          <li>ä½œæ¥­å®Œäº†å¾Œã¯é€Ÿã‚„ã‹ã«å®Œäº†å ±å‘Šã‚’è¡Œã£ã¦ãã ã•ã„</li>
          <li>è¤‡æ•°åå‹Ÿé›†ã®ã‚¯ã‚¨ã‚¹ãƒˆã¯ã€å€‹äººã§ã‚‚å¿œå‹Ÿå¯èƒ½ã§ã™ï¼ˆå ±é…¬ã¯äººæ•°åˆ†ï¼‰</li>
        </ul>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2026 ç·ç¤¾å¸‚ã‚®ãƒ«ãƒ‰äº‹å‹™å±€ | ã‚ãã‚ãã‚®ãƒ«ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

  <script src="js/config.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const questId = urlParams.get('id');
    let currentQuest = null;

    window.addEventListener('DOMContentLoaded', () => {
      if (questId) {
        loadQuestDetail(questId);
      } else {
        document.getElementById('questDetail').innerHTML = 
          '<p class="error">ã‚¯ã‚¨ã‚¹ãƒˆIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
      }
    });

    /**
     * ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°èª­ã¿è¾¼ã¿
     */
    async function loadQuestDetail(id) {
      try {
        const response = await fetch(`${GAS_WEB_APP_URL}?action=getQuestDetail&id=${id}`);
        const quest = await response.json();
        
        if (quest.error) {
          throw new Error(quest.error);
        }
        
        currentQuest = quest;
        displayQuestDetail(quest);
        displaySlotInfo(quest);
      } catch (error) {
        console.error('ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('questDetail').innerHTML = 
          '<p class="error">ã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
      }
    }

    /**
     * ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°è¡¨ç¤º
     */
    function displayQuestDetail(quest) {
      const container = document.getElementById('questDetail');
      const perPersonReward = Math.floor(quest.reward / quest.requiredMembers);
      
      container.innerHTML = `
        <div class="quest-detail-header">
          <h2>${escapeHtml(quest.title)}</h2>
          <div class="quest-meta">
            <span class="difficulty-large">${quest.difficulty}</span>
            <span class="recommend-rank">æ¨å¥¨ãƒ©ãƒ³ã‚¯: ${quest.recommendRank}</span>
          </div>
        </div>

        <div class="quest-detail-body">
          <div class="detail-section">
            <h3>ğŸ“‹ ã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±</h3>
            <table class="detail-table">
              <tr>
                <th>ã‚«ãƒ†ã‚´ãƒª</th>
                <td><span class="category-tag">${escapeHtml(quest.category)}</span></td>
              </tr>
              <tr>
                <th>å®Ÿæ–½å ´æ‰€</th>
                <td>${escapeHtml(quest.location)}</td>
              </tr>
              <tr>
                <th>å¸Œæœ›æ—¥æ™‚</th>
                <td>${formatDate(quest.desiredDate)}</td>
              </tr>
              <tr>
                <th>æ‰€è¦æ™‚é–“</th>
                <td>${quest.estimatedHours}æ™‚é–“</td>
              </tr>
              <tr>
                <th>å‹Ÿé›†äººæ•°</th>
                <td>${quest.requiredMembers}å</td>
              </tr>
              <tr>
                <th>å ±é…¬</th>
                <td class="reward-amount">
                  ğŸ’° ${quest.requiredMembers > 1 ? 
                    `Â¥${perPersonReward.toLocaleString()}/äºº <small style="color: #666;">(ç·é¡: Â¥${quest.reward.toLocaleString()})</small>` : 
                    `Â¥${quest.reward.toLocaleString()}`
                  }
                </td>
              </tr>
            </table>
          </div>

          <div class="detail-section">
            <h3>ğŸ“ å†…å®¹è©³ç´°</h3>
            <div class="description-box">
              ${escapeHtml(quest.description).replace(/\n/g, '<br>')}
            </div>
          </div>

          ${quest.equipment ? `
          <div class="detail-section">
            <h3>ğŸ› ï¸ å¿…è¦ãªé“å…·ãƒ»è£…å‚™</h3>
            <div class="equipment-box">
              ${escapeHtml(quest.equipment).replace(/\n/g, '<br>')}
            </div>
          </div>
          ` : ''}

          ${quest.notes ? `
          <div class="detail-section">
            <h3>âš ï¸ æ³¨æ„äº‹é …ãƒ»å‚™è€ƒ</h3>
            <div class="notes-box">
              ${escapeHtml(quest.notes).replace(/\n/g, '<br>')}
            </div>
          </div>
          ` : ''}

          <div class="detail-section">
            <h3>ğŸ‘¤ ä¾é ¼ä¸»æƒ…å ±</h3>
            <p>ä¾é ¼ä¸»: ${escapeHtml(quest.clientName || 'éå…¬é–‹')}</p>
            <p class="note">â€»è©³ç´°ãªé€£çµ¡å…ˆã¯å—æ³¨å¾Œã«é–‹ç¤ºã•ã‚Œã¾ã™</p>
          </div>

          <div class="detail-section">
            <h3>ğŸ–ï¸ ç²å¾—çµŒé¨“å€¤</h3>
            <p class="exp-info">ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Œäº†ã™ã‚‹ã¨ <strong>${getExpByDifficulty(quest.difficulty)} EXP</strong> ã‚’ç²å¾—ã§ãã¾ã™</p>
          </div>
        </div>
      `;
    }

    /**
     * å‹Ÿé›†æ æƒ…å ±è¡¨ç¤º
     */
    function displaySlotInfo(quest) {
      const slotInfo = document.getElementById('questSlotInfo');
      const remainingSlots = quest.remainingSlots !== undefined ? quest.remainingSlots : quest.requiredMembers;
      const currentMembers = quest.currentMembers || 0;
      const remainingPercent = Math.round((remainingSlots / quest.requiredMembers) * 100);
      
      let slotClass = 'slots-plenty';
      if (remainingPercent <= 30) slotClass = 'slots-few';
      else if (remainingPercent <= 60) slotClass = 'slots-medium';
      
      slotInfo.className = `slot-info ${slotClass}`;
      slotInfo.innerHTML = `
        <div class="slot-display">
          <h4>ğŸ“Š å‹Ÿé›†çŠ¶æ³</h4>
          <p class="slot-numbers">
            æ®‹ã‚Š <span class="remaining">${remainingSlots}å</span> / ${quest.requiredMembers}å
          </p>
          ${currentMembers > 0 ? `<p class="slot-note">â€» ç¾åœ¨${currentMembers}åãŒå¿œå‹Ÿæ¸ˆã¿ã§ã™</p>` : ''}
        </div>
      `;
      
      // å‚åŠ äººæ•°ã®æœ€å¤§å€¤ã‚’è¨­å®š
      document.getElementById('participantCount').max = remainingSlots;
    }

    /**
     * å—æ³¨ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ
     */
    function togglePartyInput() {
      const acceptType = document.getElementById('acceptType').value;
      const partyIdGroup = document.getElementById('partyIdGroup');
      const participantCountGroup = document.getElementById('participantCountGroup');
      const participantCountInput = document.getElementById('participantCount');
      
      if (acceptType === 'ãƒ‘ãƒ¼ãƒ†ã‚£') {
        partyIdGroup.style.display = 'block';
        participantCountGroup.style.display = 'block';
        participantCountInput.required = true;
      } else {
        partyIdGroup.style.display = 'none';
        participantCountGroup.style.display = 'none';
        participantCountInput.required = false;
        participantCountInput.value = 1;
      }
      
      updateRewardPreview();
    }

    /**
     * å ±é…¬ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
     */
    function updateRewardPreview() {
      const acceptType = document.getElementById('acceptType').value;
      const participantCount = parseInt(document.getElementById('participantCount').value) || 1;
      const rewardPreview = document.getElementById('rewardPreview');
      
      if (!currentQuest) return;
      
      const perPersonReward = Math.floor(currentQuest.reward / currentQuest.requiredMembers);
      const remainingSlots = currentQuest.remainingSlots !== undefined ? currentQuest.remainingSlots : currentQuest.requiredMembers;
      
      if (acceptType === 'å€‹äºº') {
        rewardPreview.textContent = `ğŸ’° ã‚ãªãŸã®å ±é…¬: Â¥${perPersonReward.toLocaleString()}`;
        rewardPreview.style.color = '#2563eb';
        rewardPreview.style.display = 'block';
      } else if (acceptType === 'ãƒ‘ãƒ¼ãƒ†ã‚£') {
        const totalReward = perPersonReward * participantCount;
        rewardPreview.textContent = `ğŸ’° ãƒ‘ãƒ¼ãƒ†ã‚£å ±é…¬: Â¥${totalReward.toLocaleString()} (Â¥${perPersonReward.toLocaleString()} Ã— ${participantCount}å)`;
        rewardPreview.style.color = '#2563eb';
        rewardPreview.style.display = 'block';
        
        if (participantCount > remainingSlots) {
          rewardPreview.textContent = `âš ï¸ æ®‹ã‚Šå‹Ÿé›†äººæ•°(${remainingSlots}å)ã‚’è¶…ãˆã¦ã„ã¾ã™`;
          rewardPreview.style.color = '#e63946';
        }
      } else {
        rewardPreview.style.display = 'none';
      }
    }

    /**
     * ã‚¯ã‚¨ã‚¹ãƒˆå—æ³¨
     */
    async function acceptQuest() {
      const memberId = document.getElementById('memberId').value;
      const acceptType = document.getElementById('acceptType').value;
      const message = document.getElementById('message').value;
      
      if (!memberId) {
        alert('ãƒ¡ãƒ³ãƒãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!acceptType) {
        alert('å—æ³¨ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      let acceptorId = memberId;
      let participantCount = 1;
      
      if (acceptType === 'ãƒ‘ãƒ¼ãƒ†ã‚£') {
        const partyId = document.getElementById('partyId').value;
        if (!partyId) {
          alert('ãƒ‘ãƒ¼ãƒ†ã‚£IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        acceptorId = partyId;
        participantCount = parseInt(document.getElementById('participantCount').value) || 1;
        
        const remainingSlots = currentQuest.remainingSlots !== undefined ? currentQuest.remainingSlots : currentQuest.requiredMembers;
        if (participantCount > remainingSlots) {
          alert(`æ®‹ã‚Šå‹Ÿé›†äººæ•°ã¯${remainingSlots}åã§ã™`);
          return;
        }
      }

      if (!confirm(`${acceptType}ã¨ã—ã¦${participantCount}åã§å—æ³¨ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      try {
        const response = await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain',
          },
          body: JSON.stringify({
            action: 'acceptQuest',
            questId: questId,
            acceptorId: acceptorId,
            acceptorType: acceptType,
            participantCount: participantCount,
            message: message
          })
        });

        const result = await response.json();
        
        if (result.success) {
          alert(`âœ… ${result.message}\n\nãƒã‚¤ãƒšãƒ¼ã‚¸ã‹ã‚‰é€²æ—ã‚’ç¢ºèªã§ãã¾ã™ã€‚`);
          window.location.href = 'mypage.html';
        } else {
          alert('âŒ å—æ³¨ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
        }
      } catch (error) {
        console.error('å—æ³¨ã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ å—æ³¨å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }

    /**
     * é›£æ˜“åº¦ã‹ã‚‰çµŒé¨“å€¤ã‚’å–å¾—
     */
    function getExpByDifficulty(difficulty) {
      const expTable = {
        'â˜…': 10,
        'â˜…â˜…': 20,
        'â˜…â˜…â˜…': 40,
        'â˜…â˜…â˜…â˜…': 70,
        'â˜…â˜…â˜…â˜…â˜…': 100
      };
      return expTable[difficulty] || 10;
    }

    /**
     * æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
     */
    function formatDate(dateString) {
      if (!dateString) return '-';
      
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '-';
        
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hour = String(date.getHours()).padStart(2, '0');
        const minute = String(date.getMinutes()).padStart(2, '0');
        
        return `${year}å¹´${month}æœˆ${day}æ—¥ ${hour}:${minute}`;
      } catch (error) {
        return '-';
      }
    }

    /**
     * XSSå¯¾ç­–
     */
    function escapeHtml(text) {
      if (!text) return '';
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.toString().replace(/[&<>"']/g, m => map[m]);
    }
  </script>
</body>
</html>