<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ - ã‚ãã‚ãã‚®ãƒ«ãƒ‰</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <div class="container">
      <h1>âš”ï¸ ã‚ãã‚ãã‚®ãƒ«ãƒ‰</h1>
      <nav>
        <a href="index.html">ã‚¯ã‚¨ã‚¹ãƒˆæ²ç¤ºæ¿</a>
        <a href="ranking.html">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
        <a href="member.html">ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²</a>
        <a href="client.html">ä¾é ¼ä¸»ç™»éŒ²</a>
        <a href="mypage.html">ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="mypage-section">
      <h2>ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</h2>
      
      <!-- ãƒ­ã‚°ã‚¤ãƒ³å‰ã®è¡¨ç¤º -->
      <div id="loginPrompt" class="login-box">
        <h3>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</h3>
        <p>ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</p>
        <form id="loginForm" onsubmit="handleLogin(event)">
          <div class="form-group">
            <label for="loginId">ãƒ¡ãƒ³ãƒãƒ¼ID ã¾ãŸã¯ ä¾é ¼ä¸»ID</label>
            <input type="text" id="loginId" name="loginId" required placeholder="ä¾‹: M0001 ã¾ãŸã¯ C0001">
          </div>
          <div class="form-group">
            <label for="email">ç™»éŒ²ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input type="email" id="email" name="email" required>
          </div>
          <button type="submit" class="btn-primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </form>
        <p class="note">â€»æœ¬æ ¼å®Ÿè£…æ™‚ã¯èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‚’å°å…¥ã—ã¾ã™</p>
      </div>

      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
      <div id="loadingMypage" class="loading" style="display: none;">
        <p>ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
      </div>

      <!-- ã‚®ãƒ«ãƒ‰ãƒ¡ãƒ³ãƒãƒ¼ç”¨ãƒã‚¤ãƒšãƒ¼ã‚¸ -->
      <div id="memberMypage" class="mypage-content" style="display: none;">
        <div class="profile-card">
          <div class="profile-header">
            <h3 id="memberNickname">-</h3>
            <span class="rank-badge" id="memberRankBadge">ãƒ©ãƒ³ã‚¯F</span>
          </div>
          <div class="profile-stats">
            <div class="stat-item">
              <span class="stat-label">çµŒé¨“å€¤</span>
              <span class="stat-value" id="memberExp">0 EXP</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">å®Œäº†ã‚¯ã‚¨ã‚¹ãƒˆ</span>
              <span class="stat-value" id="memberQuests">0ä»¶</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">è©•ä¾¡</span>
              <span class="stat-value" id="memberRating">â­0.0</span>
            </div>
          </div>
          <div class="exp-bar">
            <div class="exp-progress" id="expProgress" style="width: 0%"></div>
          </div>
          <p class="exp-text" id="expText">æ¬¡ã®ãƒ©ãƒ³ã‚¯ã¾ã§ã‚ã¨ - EXP</p>
        </div>

        <div class="tabs">
          <button class="tab-btn active" onclick="showTab('accepted')">å—æ³¨ä¸­ã®ã‚¯ã‚¨ã‚¹ãƒˆ</button>
          <button class="tab-btn" onclick="showTab('completed')">å®Œäº†ã—ãŸã‚¯ã‚¨ã‚¹ãƒˆ</button>
          <button class="tab-btn" onclick="showTab('profile')">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</button>
        </div>

        <div id="acceptedTab" class="tab-content">
          <h3>ğŸ“‹ å—æ³¨ä¸­ã®ã‚¯ã‚¨ã‚¹ãƒˆ</h3>
          <div id="acceptedQuestList" class="quest-list">
            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
          </div>
        </div>

        <div id="completedTab" class="tab-content" style="display: none;">
          <h3>âœ… å®Œäº†ã—ãŸã‚¯ã‚¨ã‚¹ãƒˆ</h3>
          <div id="completedQuestList" class="quest-list">
            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
          </div>
        </div>

        <div id="profileTab" class="tab-content" style="display: none;">
          <h3>âœï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h3>
          <form id="profileEditForm" onsubmit="updateProfile(event)">
            <div class="form-group">
              <label>ãƒ¡ãƒ³ãƒãƒ¼ID</label>
              <input type="text" id="profileMemberId" readonly>
            </div>
            <div class="form-group">
              <label>æ°å</label>
              <input type="text" id="profileName" readonly>
            </div>
            <div class="form-group">
              <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
              <input type="text" id="profileNickname">
            </div>
            <div class="form-group">
              <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
              <input type="email" id="profileEmail">
            </div>
            <div class="form-group">
              <label>é›»è©±ç•ªå·</label>
              <input type="tel" id="profilePhone">
            </div>
            <div class="form-group">
              <label>ã‚¹ã‚­ãƒ«ã‚¿ã‚°</label>
              <input type="text" id="profileSkills">
            </div>
            <button type="submit" class="btn-primary">æ›´æ–°ã™ã‚‹</button>
          </form>
        </div>
      </div>

      <!-- ä¾é ¼ä¸»ç”¨ãƒã‚¤ãƒšãƒ¼ã‚¸ -->
      <div id="clientMypage" class="mypage-content" style="display: none;">
        <div class="profile-card">
          <h3 id="clientName">-</h3>
          <p>ä¾é ¼ä¸»ID: <span id="clientId">-</span></p>
          <p>ç¨®åˆ¥: <span id="clientType">-</span></p>
        </div>

        <div class="tabs">
          <button class="tab-btn active" onclick="showClientTab('posting')">å‹Ÿé›†ä¸­ã®ã‚¯ã‚¨ã‚¹ãƒˆ</button>
          <button class="tab-btn" onclick="showClientTab('inProgress')">é€²è¡Œä¸­ã®ã‚¯ã‚¨ã‚¹ãƒˆ</button>
          <button class="tab-btn" onclick="showClientTab('history')">å®Œäº†å±¥æ­´</button>
          <button class="tab-btn" onclick="showClientTab('newQuest')">æ–°è¦ã‚¯ã‚¨ã‚¹ãƒˆæŠ•ç¨¿</button>
        </div>

        <div id="postingTab" class="tab-content">
          <h3>ğŸ“¢ å‹Ÿé›†ä¸­ã®ã‚¯ã‚¨ã‚¹ãƒˆ</h3>
          <div id="postingQuestList" class="quest-list">
            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
          </div>
        </div>

        <div id="inProgressTab" class="tab-content" style="display: none;">
          <h3>ğŸ”„ é€²è¡Œä¸­ã®ã‚¯ã‚¨ã‚¹ãƒˆ</h3>
          <div id="inProgressQuestList" class="quest-list">
            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
          </div>
        </div>

        <div id="historyTab" class="tab-content" style="display: none;">
          <h3>âœ… å®Œäº†å±¥æ­´</h3>
          <div id="historyQuestList" class="quest-list">
            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
          </div>
        </div>

        <div id="newQuestTab" class="tab-content" style="display: none;">
          <h3>ğŸ“ æ–°è¦ã‚¯ã‚¨ã‚¹ãƒˆæŠ•ç¨¿</h3>
          <p><a href="quest-post.html" class="btn-primary" style="display: inline-block; text-decoration: none;">ã‚¯ã‚¨ã‚¹ãƒˆæŠ•ç¨¿ãƒšãƒ¼ã‚¸ã¸</a></p>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2026 ç·ç¤¾å¸‚ã‚®ãƒ«ãƒ‰äº‹å‹™å±€ | ã‚ãã‚ãã‚®ãƒ«ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

  <script src="js/config.js"></script>
  <script>
    let currentUser = null;
    let currentUserType = null;

    async function handleLogin(event) {
      event.preventDefault();
      
      const loginId = document.getElementById('loginId').value;
      const email = document.getElementById('email').value;
      
      const loading = document.getElementById('loadingMypage');
      const loginPrompt = document.getElementById('loginPrompt');
      
      loading.style.display = 'block';
      loginPrompt.style.display = 'none';

      try {
        // IDåˆ¤å®š
        if (loginId.startsWith('M')) {
          // ãƒ¡ãƒ³ãƒãƒ¼ãƒ­ã‚°ã‚¤ãƒ³
          await loadMemberData(loginId, email);
        } else if (loginId.startsWith('C')) {
          // ä¾é ¼ä¸»ãƒ­ã‚°ã‚¤ãƒ³
          await loadClientData(loginId, email);
        } else {
          throw new Error('ç„¡åŠ¹ãªIDã§ã™');
        }
      } catch (error) {
        console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error.message);
        loading.style.display = 'none';
        loginPrompt.style.display = 'block';
      }
    }

    async function loadMemberData(memberId, email) {
      try {
        const response = await fetch(`${GAS_WEB_APP_URL}?action=getMemberData&id=${memberId}&email=${email}`);
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.message || 'ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }

        currentUser = data.member;
        currentUserType = 'member';

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
        document.getElementById('memberNickname').textContent = data.member.nickname;
        document.getElementById('memberRankBadge').textContent = `ãƒ©ãƒ³ã‚¯${data.member.rank}`;
        document.getElementById('memberRankBadge').className = `rank-badge rank-${data.member.rank}`;
        document.getElementById('memberExp').textContent = `${data.member.exp} EXP`;
        document.getElementById('memberQuests').textContent = `${data.member.completedQuests}ä»¶`;
        document.getElementById('memberRating').textContent = `â­${data.member.rating > 0 ? data.member.rating.toFixed(1) : 'æœªè©•ä¾¡'}`;

        // çµŒé¨“å€¤ãƒãƒ¼
        const expProgress = calculateExpProgress(data.member.rank, data.member.exp);
        document.getElementById('expProgress').style.width = `${expProgress.percentage}%`;
        document.getElementById('expText').textContent = `æ¬¡ã®ãƒ©ãƒ³ã‚¯ã¾ã§ã‚ã¨${expProgress.remaining} EXP`;

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ 
        document.getElementById('profileMemberId').value = data.member.id;
        document.getElementById('profileName').value = data.member.name;
        document.getElementById('profileNickname').value = data.member.nickname;
        document.getElementById('profileEmail').value = data.member.email;
        document.getElementById('profilePhone').value = data.member.phone;
        document.getElementById('profileSkills').value = data.member.skills;

        // ã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        await loadMemberQuests(memberId);

        document.getElementById('loadingMypage').style.display = 'none';
        document.getElementById('memberMypage').style.display = 'block';
      } catch (error) {
        throw error;
      }
    }

    async function loadClientData(clientId, email) {
      try {
        const response = await fetch(`${GAS_WEB_APP_URL}?action=getClientData&id=${clientId}&email=${email}`);
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.message || 'ä¾é ¼ä¸»æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }

        currentUser = data.client;
        currentUserType = 'client';

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º
        document.getElementById('clientName').textContent = data.client.name;
        document.getElementById('clientId').textContent = data.client.id;
        document.getElementById('clientType').textContent = data.client.type || '-';

        // ã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        await loadClientQuests(clientId);

        document.getElementById('loadingMypage').style.display = 'none';
        document.getElementById('clientMypage').style.display = 'block';
      } catch (error) {
        throw error;
      }
    }

    async function loadMemberQuests(memberId) {
      try {
        const response = await fetch(`${GAS_WEB_APP_URL}?action=getMemberQuests&id=${memberId}`);
        const data = await response.json();

        // å—æ³¨ä¸­ã®ã‚¯ã‚¨ã‚¹ãƒˆ
        const acceptedList = document.getElementById('acceptedQuestList');
        acceptedList.innerHTML = '';
        
        if (data.accepted && data.accepted.length > 0) {
          data.accepted.forEach(quest => {
            acceptedList.innerHTML += createQuestItemHTML(quest, 'accepted');
          });
        } else {
          acceptedList.innerHTML = '<p class="no-data">å—æ³¨ä¸­ã®ã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        }

        // å®Œäº†ã—ãŸã‚¯ã‚¨ã‚¹ãƒˆ
        const completedList = document.getElementById('completedQuestList');
        completedList.innerHTML = '';
        
        if (data.completed && data.completed.length > 0) {
          data.completed.forEach(quest => {
            completedList.innerHTML += createQuestItemHTML(quest, 'completed');
          });
        } else {
          completedList.innerHTML = '<p class="no-data">å®Œäº†ã—ãŸã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        }
      } catch (error) {
        console.error('ã‚¯ã‚¨ã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    async function loadClientQuests(clientId) {
      try {
        const response = await fetch(`${GAS_WEB_APP_URL}?action=getClientQuests&id=${clientId}`);
        const data = await response.json();

        // å‹Ÿé›†ä¸­ã®ã‚¯ã‚¨ã‚¹ãƒˆ
        const postingList = document.getElementById('postingQuestList');
        postingList.innerHTML = '';
        
        if (data.posting && data.posting.length > 0) {
          data.posting.forEach(quest => {
            postingList.innerHTML += createClientQuestItemHTML(quest, 'posting');
          });
        } else {
          postingList.innerHTML = '<p class="no-data">å‹Ÿé›†ä¸­ã®ã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        }

        // é€²è¡Œä¸­ã®ã‚¯ã‚¨ã‚¹ãƒˆ
        const inProgressList = document.getElementById('inProgressQuestList');
        inProgressList.innerHTML = '';
        
        if (data.inProgress && data.inProgress.length > 0) {
          data.inProgress.forEach(quest => {
            inProgressList.innerHTML += createClientQuestItemHTML(quest, 'inProgress');
          });
        } else {
          inProgressList.innerHTML = '<p class="no-data">é€²è¡Œä¸­ã®ã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        }

        // å®Œäº†å±¥æ­´
        const historyList = document.getElementById('historyQuestList');
        historyList.innerHTML = '';
        
        if (data.history && data.history.length > 0) {
          data.history.forEach(quest => {
            historyList.innerHTML += createClientQuestItemHTML(quest, 'history');
          });
        } else {
          historyList.innerHTML = '<p class="no-data">å®Œäº†ã—ãŸã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        }
      } catch (error) {
        console.error('ã‚¯ã‚¨ã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    function createQuestItemHTML(quest, status) {
      const isCompleted = status === 'completed';
      return `
        <div class="quest-item ${isCompleted ? 'completed' : ''}">
          <div class="quest-info">
            <h4>${escapeHtml(quest.title)}</h4>
            <p>ğŸ“ ${escapeHtml(quest.location)}</p>
            <p>ğŸ“… ${escapeHtml(quest.desiredDate)}</p>
            <p>ğŸ’° å ±é…¬: ${quest.reward.toLocaleString()}å††</p>
            ${isCompleted ? `
              <p>â­ è©•ä¾¡: ${quest.rating || 'æœªè©•ä¾¡'}</p>
              <p>ğŸ–ï¸ ç²å¾—çµŒé¨“å€¤: +${quest.exp || 0} EXP</p>
            ` : ''}
          </div>
          <div class="quest-actions">
            ${!isCompleted ? `
              <button onclick="reportComplete('${quest.id}')" class="btn-primary">å®Œäº†å ±å‘Š</button>
              <button onclick="reportProblem('${quest.id}')" class="btn-secondary">å•é¡Œå ±å‘Š</button>
            ` : ''}
          </div>
        </div>
      `;
    }

    function createClientQuestItemHTML(quest, status) {
      let actions = '';
      
      if (status === 'posting') {
        actions = `
          <button onclick="viewApplicants('${quest.id}')" class="btn-primary">å¿œå‹Ÿè€…ã‚’è¦‹ã‚‹</button>
          <button onclick="cancelQuest('${quest.id}')" class="btn-secondary">å‹Ÿé›†ä¸­æ­¢</button>
        `;
      } else if (status === 'inProgress') {
        actions = `
          <button onclick="confirmComplete('${quest.id}')" class="btn-primary">å®Œäº†ç¢ºèª</button>
          <button onclick="contactMember('${quest.acceptorId}')" class="btn-secondary">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</button>
        `;
      }

      return `
        <div class="quest-item ${status === 'history' ? 'completed' : ''}">
          <div class="quest-info">
            <h4>${escapeHtml(quest.title)}</h4>
            ${quest.acceptorName ? `<p>ğŸ‘¤ å—æ³¨è€…: ${escapeHtml(quest.acceptorName)}</p>` : ''}
            <p>ğŸ“… ${status === 'posting' ? 'å¸Œæœ›æ—¥' : status === 'inProgress' ? 'å®Ÿæ–½äºˆå®š' : 'å®Œäº†æ—¥'}: ${escapeHtml(quest.date)}</p>
            <p>ğŸ’° å ±é…¬: ${quest.reward.toLocaleString()}å††</p>
            ${status === 'history' && quest.rating ? `<p>â­ ã‚ãªãŸã®è©•ä¾¡: ${quest.rating}</p>` : ''}
          </div>
          <div class="quest-actions">
            ${actions}
          </div>
        </div>
      `;
    }

    function calculateExpProgress(rank, exp) {
      const rankThresholds = {
        'F': 0,
        'E': 10,
        'D': 50,
        'C': 150,
        'B': 300,
        'A': 500,
        'S': 1000
      };

      const ranks = ['F', 'E', 'D', 'C', 'B', 'A', 'S'];
      const currentIndex = ranks.indexOf(rank);
      
      if (currentIndex === ranks.length - 1) {
        return { percentage: 100, remaining: 0 };
      }

      const currentThreshold = rankThresholds[rank];
      const nextThreshold = rankThresholds[ranks[currentIndex + 1]];
      const range = nextThreshold - currentThreshold;
      const progress = exp - currentThreshold;
      const percentage = Math.min((progress / range) * 100, 100);
      const remaining = Math.max(nextThreshold - exp, 0);

      return { percentage, remaining };
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      if (tabName === 'accepted') {
        document.getElementById('acceptedTab').style.display = 'block';
      } else if (tabName === 'completed') {
        document.getElementById('completedTab').style.display = 'block';
      } else if (tabName === 'profile') {
        document.getElementById('profileTab').style.display = 'block';
      }
      
      event.target.classList.add('active');
    }

    function showClientTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      const tabMap = {
        'posting': 'postingTab',
        'inProgress': 'inProgressTab',
        'history': 'historyTab',
        'newQuest': 'newQuestTab'
      };
      
      document.getElementById(tabMap[tabName]).style.display = 'block';
      event.target.classList.add('active');
    }

    async function reportComplete(questId) {
      const comment = prompt('å®Œäº†å ±å‘Šã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!comment) return;

      try {
        const response = await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'reportComplete',
            questId: questId,
            memberId: currentUser.id,
            comment: comment
          })
        });

        const result = await response.json();
        
        if (result.success) {
          alert('âœ… å®Œäº†å ±å‘Šã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚\nä¾é ¼ä¸»ã®ç¢ºèªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚');
          await loadMemberQuests(currentUser.id);
        } else {
          alert('âŒ å ±å‘Šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
        }
      } catch (error) {
        console.error('å ±å‘Šã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ å ±å‘Šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }

    async function reportProblem(questId) {
      const problem = prompt('ç™ºç”Ÿã—ãŸå•é¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!problem) return;

      try {
        const response = await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'reportProblem',
            questId: questId,
            memberId: currentUser.id,
            problem: problem
          })
        });

        const result = await response.json();
        
        if (result.success) {
          alert('âœ… å•é¡Œå ±å‘Šã‚’äº‹å‹™å±€ã«é€ä¿¡ã—ã¾ã—ãŸã€‚\näº‹å‹™å±€ã‹ã‚‰é€£çµ¡ãŒã‚ã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚');
        } else {
          alert('âŒ å ±å‘Šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
        }
      } catch (error) {
        console.error('å ±å‘Šã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ å ±å‘Šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }

    async function confirmComplete(questId) {
      const rating = prompt('è©•ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ1-5ï¼‰:');
      if (!rating || rating < 1 || rating > 5) {
        alert('1ã‹ã‚‰5ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const comment = prompt('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!comment) return;

      try {
        const response = await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'confirmComplete',
            questId: questId,
            clientId: currentUser.id,
            rating: parseInt(rating),
            comment: comment
          })
        });

        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Œäº†ç¢ºèªã—ã¾ã—ãŸã€‚\nå ±é…¬ã®æ”¯æ‰•ã„å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ã€‚');
          await loadClientQuests(currentUser.id);
        } else {
          alert('âŒ ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
        }
      } catch (error) {
        console.error('ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ ç¢ºèªå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }

    function viewApplicants(questId) {
      alert('å¿œå‹Ÿè€…ä¸€è¦§æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™');
    }

    function cancelQuest(questId) {
      if (confirm('æœ¬å½“ã«å‹Ÿé›†ã‚’ä¸­æ­¢ã—ã¾ã™ã‹ï¼Ÿ')) {
        alert('å‹Ÿé›†ä¸­æ­¢æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™');
      }
    }

    function contactMember(memberId) {
      alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™');
    }

    async function updateProfile(event) {
      event.preventDefault();
      alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™');
    }

    function escapeHtml(text) {
      if (!text) return '';
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.toString().replace(/[&<>"']/g, m => map[m]);
    }
    /**
 * æ—¥ä»˜ã‚’æ—¥æœ¬èªå½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
 */
function formatDate(dateString) {
  if (!dateString) return '-';
  
  try {
    const date = new Date(dateString);
    
    // ç„¡åŠ¹ãªæ—¥ä»˜ãƒã‚§ãƒƒã‚¯
    if (isNaN(date.getTime())) return '-';
    
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hour = String(date.getHours()).padStart(2, '0');
    const minute = String(date.getMinutes()).padStart(2, '0');
    
    return `${year}å¹´${month}æœˆ${day}æ—¥ ${hour}:${minute}`;
  } catch (error) {
    return '-';
  }
}

/**
 * æ—¥ä»˜ã®ã¿è¡¨ç¤ºï¼ˆæ™‚åˆ»ãªã—ï¼‰
 */
function formatDateOnly(dateString) {
  if (!dateString) return '-';
  
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return '-';
    
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    
    return `${year}å¹´${month}æœˆ${day}æ—¥`;
  } catch (error) {
    return '-';
  }
}

/**
 * ç›¸å¯¾æ™‚é–“è¡¨ç¤ºï¼ˆâ—‹æ—¥å‰ã€â—‹æ™‚é–“å‰ãªã©ï¼‰
 */
function formatRelativeTime(dateString) {
  if (!dateString) return '-';
  
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return '-';
    
    const now = new Date();
    const diffMs = now - date;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHour = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHour / 24);
    
    if (diffSec < 60) return `${diffSec}ç§’å‰`;
    if (diffMin < 60) return `${diffMin}åˆ†å‰`;
    if (diffHour < 24) return `${diffHour}æ™‚é–“å‰`;
    if (diffDay < 7) return `${diffDay}æ—¥å‰`;
    
    return formatDateOnly(dateString);
  } catch (error) {
    return '-';
  }
}
  </script>
</body>
</html>
