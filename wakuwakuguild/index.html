<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚ãã‚ãã‚®ãƒ«ãƒ‰ - ã‚¯ã‚¨ã‚¹ãƒˆæ²ç¤ºæ¿</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <div class="container">
      <h1>âš”ï¸ ã‚ãã‚ãã‚®ãƒ«ãƒ‰</h1>
      <nav>
        <a href="index.html">ã‚¯ã‚¨ã‚¹ãƒˆæ²ç¤ºæ¿</a>
        <a href="ranking.html">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
        <a href="member.html">ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²</a>
        <a href="client.html">ä¾é ¼ä¸»ç™»éŒ²</a>
        <a href="mypage.html">ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h2>ğŸ—ºï¸ å‹Ÿé›†ä¸­ã®ã‚¯ã‚¨ã‚¹ãƒˆ</h2>
      <p>ç·ç¤¾å¸‚ã‚®ãƒ«ãƒ‰äº‹å‹™å±€ãŒèªå®šã—ãŸä¾é ¼ä¸€è¦§ã§ã™ã€‚ã‚ãªãŸã®ã‚¹ã‚­ãƒ«ã§åœ°åŸŸã‚’æ”¯ãˆã‚ˆã†ï¼</p>
    </section>

    <div class="filter-bar">
      <label>
        ã‚«ãƒ†ã‚´ãƒª:
        <select id="categoryFilter">
          <option value="">ã™ã¹ã¦</option>
          <option value="è‰åˆˆã‚Š">è‰åˆˆã‚Š</option>
          <option value="æ¸…æƒ">æ¸…æƒ</option>
          <option value="åŠ›ä»•äº‹">åŠ›ä»•äº‹</option>
          <option value="ITæ”¯æ´">ITæ”¯æ´</option>
          <option value="æ–™ç†ãƒ»èª¿ç†">æ–™ç†ãƒ»èª¿ç†</option>
          <option value="ã‚¤ãƒ™ãƒ³ãƒˆæ‰‹ä¼ã„">ã‚¤ãƒ™ãƒ³ãƒˆæ‰‹ä¼ã„</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </label>
      <label>
        é›£æ˜“åº¦:
        <select id="difficultyFilter">
          <option value="">ã™ã¹ã¦</option>
          <option value="â˜…">â˜…</option>
          <option value="â˜…â˜…">â˜…â˜…</option>
          <option value="â˜…â˜…â˜…">â˜…â˜…â˜…</option>
          <option value="â˜…â˜…â˜…â˜…">â˜…â˜…â˜…â˜…</option>
          <option value="â˜…â˜…â˜…â˜…â˜…">â˜…â˜…â˜…â˜…â˜…</option>
        </select>
      </label>
      <label>
        æ¨å¥¨ãƒ©ãƒ³ã‚¯:
        <select id="rankFilter">
          <option value="">ã™ã¹ã¦</option>
          <option value="F">F</option>
          <option value="E">E</option>
          <option value="D">D</option>
          <option value="C">C</option>
          <option value="B">B</option>
          <option value="A">A</option>
          <option value="S">S</option>
        </select>
      </label>
      <button onclick="applyFilter()">çµã‚Šè¾¼ã¿</button>
      <button onclick="resetFilter()" class="btn-secondary">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div class="loading" id="loading">
      <p>ğŸ”„ ã‚¯ã‚¨ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>

    <div id="questList" class="quest-grid" style="display: none;">
      <!-- ã‚¯ã‚¨ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
    </div>

    <div id="noQuests" class="no-data" style="display: none;">
      <p>ğŸ˜” ç¾åœ¨å‹Ÿé›†ä¸­ã®ã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
      <p>æ–°ã—ã„ã‚¯ã‚¨ã‚¹ãƒˆãŒæŠ•ç¨¿ã•ã‚Œã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„</p>
    </div>
  </main>

  <footer>
    <p>&copy; 2026 ç·ç¤¾å¸‚ã‚®ãƒ«ãƒ‰äº‹å‹™å±€ | ã‚ãã‚ãã‚®ãƒ«ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

<script src="js/config.js"></script>
<script>
  let allQuests = [];

  window.addEventListener('DOMContentLoaded', loadQuests);

  /**
   * ã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿
   */
  async function loadQuests() {
    const loading = document.getElementById('loading');
    const questList = document.getElementById('questList');
    const noQuests = document.getElementById('noQuests');

    try {
      loading.style.display = 'block';
      questList.style.display = 'none';
      noQuests.style.display = 'none';

      const response = await fetch(`${GAS_WEB_APP_URL}?action=getQuests`);
      
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }

      const quests = await response.json();
      allQuests = quests;
      
      loading.style.display = 'none';
      
      if (quests.length === 0) {
        noQuests.style.display = 'block';
      } else {
        questList.style.display = 'grid';
        displayQuests(quests);
      }
    } catch (error) {
      console.error('ã‚¯ã‚¨ã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      loading.style.display = 'none';
      questList.innerHTML = '<p class="error">âŒ ã‚¯ã‚¨ã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p>';
      questList.style.display = 'block';
    }
  }

  /**
   * ã‚¯ã‚¨ã‚¹ãƒˆè¡¨ç¤ºï¼ˆæ®‹ã‚Šå‹Ÿé›†äººæ•°å¯¾å¿œç‰ˆï¼‰
   */
  function displayQuests(quests) {
    const questList = document.getElementById('questList');
    questList.innerHTML = '';

    quests.forEach(quest => {
      const perPersonReward = Math.floor(quest.reward / quest.requiredMembers);
      
      const remainingSlots = quest.remainingSlots !== undefined ? quest.remainingSlots : quest.requiredMembers;
      const currentMembers = quest.currentMembers || 0;
      const remainingPercent = Math.round((remainingSlots / quest.requiredMembers) * 100);
      
      let slotsClass = 'slots-plenty';
      if (remainingPercent <= 30) slotsClass = 'slots-few';
      else if (remainingPercent <= 60) slotsClass = 'slots-medium';
      
      const card = document.createElement('div');
      card.className = 'quest-card';
      card.innerHTML = `
        <div class="quest-header">
          <span class="quest-category">${escapeHtml(quest.category)}</span>
          <span class="quest-difficulty">${quest.difficulty}</span>
        </div>
        <h3 class="quest-title">${escapeHtml(quest.title)}</h3>
        <div class="quest-info">
          <div class="info-item">
            <span class="info-label">ğŸ“ å ´æ‰€</span>
            <span class="info-value">${escapeHtml(quest.location)}</span>
          </div>
          <div class="info-item">
            <span class="info-label">ğŸ“… å¸Œæœ›æ—¥æ™‚</span>
            <span class="info-value">${formatDate(quest.desiredDate)}</span>
          </div>
          <div class="info-item">
            <span class="info-label">ğŸ’° å ±é…¬</span>
            <span class="info-value reward">
              ${quest.requiredMembers > 1 ? 
                `Â¥${perPersonReward.toLocaleString()}/äºº<br><small style="color: #666;">(ç·é¡: Â¥${quest.reward.toLocaleString()})</small>` : 
                `Â¥${quest.reward.toLocaleString()}`
              }
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">ğŸ‘¥ å‹Ÿé›†äººæ•°</span>
            <span class="info-value ${slotsClass}">
              <strong>${remainingSlots}å</strong> / ${quest.requiredMembers}å
              ${currentMembers > 0 ? `<br><small>(${currentMembers}åå¿œå‹Ÿæ¸ˆ)</small>` : ''}
            </span>
          </div>
        </div>
        <div class="quest-footer">
          <span class="rank-badge rank-${quest.recommendRank}">æ¨å¥¨ãƒ©ãƒ³ã‚¯: ${quest.recommendRank}</span>
          <button onclick="viewQuestDetail('${quest.id}')" class="btn-primary">è©³ç´°ã‚’è¦‹ã‚‹</button>
        </div>
      `;
      questList.appendChild(card);
    });
  }

  /**
   * ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°ãƒšãƒ¼ã‚¸ã¸é·ç§»
   */
  function viewQuestDetail(questId) {
    window.location.href = `quest-detail.html?id=${questId}`;
  }

  /**
   * ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
   */
  function applyFilter() {
    const categoryFilter = document.getElementById('categoryFilter').value;
    const difficultyFilter = document.getElementById('difficultyFilter').value;
    const rankFilter = document.getElementById('rankFilter').value;

    const filteredQuests = allQuests.filter(quest => {
      let match = true;
      
      if (categoryFilter && quest.category !== categoryFilter) {
        match = false;
      }
      
      if (difficultyFilter && quest.difficulty !== difficultyFilter) {
        match = false;
      }
      
      if (rankFilter && quest.recommendRank !== rankFilter) {
        match = false;
      }
      
      return match;
    });

    displayQuests(filteredQuests);
  }

  /**
   * ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
   */
  function resetFilter() {
    document.getElementById('categoryFilter').value = '';
    document.getElementById('difficultyFilter').value = '';
    document.getElementById('rankFilter').value = '';
    displayQuests(allQuests);
  }

  /**
   * XSSå¯¾ç­–
   */
  function escapeHtml(text) {
    if (!text) return '';
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, m => map[m]);
  }

  /**
   * æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
   */
  function formatDate(dateString) {
    if (!dateString) return '-';
    
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return '-';
      
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hour = String(date.getHours()).padStart(2, '0');
      const minute = String(date.getMinutes()).padStart(2, '0');
      
      return `${year}å¹´${month}æœˆ${day}æ—¥ ${hour}:${minute}`;
    } catch (error) {
      return '-';
    }
  }

  function formatDateOnly(dateString) {
    if (!dateString) return '-';
    
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return '-';
      
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      
      return `${year}å¹´${month}æœˆ${day}æ—¥`;
    } catch (error) {
      return '-';
    }
  }

  function formatRelativeTime(dateString) {
    if (!dateString) return '-';
    
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return '-';
      
      const now = new Date();
      const diffMs = now - date;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHour = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHour / 24);
      
      if (diffSec < 60) return `${diffSec}ç§’å‰`;
      if (diffMin < 60) return `${diffMin}åˆ†å‰`;
      if (diffHour < 24) return `${diffHour}æ™‚é–“å‰`;
      if (diffDay < 7) return `${diffDay}æ—¥å‰`;
      
      return formatDateOnly(dateString);
    } catch (error) {
      return '-';
    }
  }
</script>
</body>
</html>
